<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #1a1a1a;
      --primary-light: #2d2d2d;
      --accent: #ff6b35;
      --accent-hover: #ff5722;
      --bg: #fafafa;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --text-light: #666666;
      --text-muted: #999999;
      --border: #e5e5e5;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
    }
    
    * { box-sizing:border-box; margin:0; padding:0; }
    
    html,body{
      height:100%;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      overflow-x: hidden;
    }

    .header {
      background:var(--card-bg);
      padding:32px 20px 24px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(20px);
      background:rgba(255,255,255,0.95);
    }
    
    .header-container { max-width:1200px; margin:0 auto; }
    .logo-wrap { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
    .logo-img { width:64px; height:64px; border-radius:16px; object-fit:cover; box-shadow:var(--shadow-md); }
    .header-title { font-size:28px; font-weight:800; color:var(--primary); letter-spacing:-0.5px; line-height:1.2; }
    .header-desc { font-size:14px; color:var(--text-light); font-weight:500; margin-top:4px; }
    
    .promo-banner {
      background:linear-gradient(135deg, var(--accent) 0%, #ff8a65 100%);
      padding:12px 20px;
      border-radius:var(--radius-sm);
      text-align:center;
      color:white;
      font-weight:600;
      font-size:14px;
      letter-spacing:0.5px;
      box-shadow:var(--shadow-md);
    }

    .menu-controls { max-width:1200px; margin:24px auto 16px; padding:0 20px; display:flex; gap:12px; flex-wrap:wrap; }
    .menu-controls button {
      background:white; border:2px solid var(--border); border-radius:var(--radius-sm);
      padding:10px 20px; font-size:14px; font-weight:600; cursor:pointer;
      transition:all 0.3s; display:flex; align-items:center; gap:6px;
    }
    .menu-controls button.active { background:var(--primary); color:white; border-color:var(--primary); }

    .menu { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:24px; max-width:1200px; margin:0 auto 120px; padding:0 20px; }

    /* –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ "–ù–ï–¢ –í –ù–ê–õ–ò–ß–ò–ò" */
    .product {
      background:var(--card-bg); border-radius:var(--radius-md); overflow:hidden;
      position:relative; border:1px solid var(--border); transition:all 0.4s;
      display:flex; flex-direction:column;
    }
    .product:hover { transform:translateY(-8px); box-shadow:var(--shadow-lg); }

    .product.unavailable {
      filter: grayscale(0.4);
    }
    .product.unavailable .product-img {
      opacity: 0.6;
    }
    .product.unavailable .add-btn, .product.unavailable .remove-btn, .product.unavailable .controls {
      display: none;
    }
    
    .prod-unavailable {
      position:absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      color: #fff;
      font-size:12px;
      border-radius:30px;
      padding: 8px 16px;
      z-index:10;
      font-weight:700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid rgba(255,255,255,0.2);
      white-space: nowrap;
    }
    
    .product-img-wrap { position:relative; width:100%; height:200px; overflow:hidden; background:#eee; }
    .product-img { width:100%; height:100%; object-fit:cover; transition:transform 0.5s; cursor:pointer; }
    .product:hover .product-img { transform:scale(1.08); }

    .dish-badge {
      position: absolute; top: 0; left: 16px; z-index: 20;
      background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%);
      color: #fff; padding: 10px 10px 12px; font-weight: 800; font-size: 10px;
      text-transform: uppercase; border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(255,140,0,0.5);
      text-align: center;
    }

    .favorite-btn {
      position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.9);
      border:none; border-radius:50%; width:40px; height:40px;
      display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10;
    }
    
    .product-content { padding:20px; flex:1; display:flex; flex-direction:column; }
    .product-name { font-size:18px; font-weight:700; margin-bottom:8px; }
    .product-desc { color:var(--text-light); font-size:14px; margin-bottom:16px; flex:1; }
    .product-footer { display:flex; align-items:center; justify-content:space-between; padding-top:16px; border-top:1px solid var(--border); }
    .product-price { font-size:20px; font-weight:700; }
    
    .controls { display:flex; align-items:center; gap:8px; background:var(--bg); padding:6px; border-radius:var(--radius-sm); }
    .add-btn { background:var(--accent); color:white; border:none; width:36px; height:36px; border-radius:8px; font-weight:bold; cursor:pointer; }
    .remove-btn { background:white; border:1px solid var(--border); width:36px; height:36px; border-radius:8px; cursor:pointer; }

    /* –°–¢–ò–õ–ò –ú–û–î–ê–õ–ö–ò –ì–ê–†–ù–ò–†–ê */
    .garnish-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
    .garnish-btn {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 20px; background: #f9f9f9; border: 2px solid var(--border);
      border-radius: 12px; cursor: pointer; transition: 0.2s; font-weight: 600;
    }
    .garnish-btn:hover { border-color: var(--accent); background: #fff; }
    .garnish-price { color: var(--accent); font-weight: 700; }

    .modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:1000; align-items:center; justify-content:center; padding:20px; }
    .modal-bg.show { display:flex; }
    .modal { background:white; border-radius:var(--radius-lg); padding:30px; max-width:500px; width:100%; position:relative; max-height:90vh; overflow-y:auto; }
    .modal-close { position:absolute; right:15px; top:15px; background:none; border:none; font-size:24px; cursor:pointer; }
    .modal-title { font-size:22px; font-weight:800; margin-bottom:20px; }

    .cart-list { list-style:none; margin-bottom:20px; }
    .cart-list li { display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--bg); border-radius:12px; margin-bottom:8px; }
    .cart-item-info { display:flex; flex-direction:column; }
    .cart-item-garnish { font-size:12px; color:var(--text-light); }
    
    .cart-fab { position:fixed; bottom:24px; right:24px; background:var(--primary); width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; z-index:900; box-shadow:var(--shadow-lg); }
    .cart-fab-count { position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; width:24px; height:24px; border-radius:50%; font-size:12px; font-weight:800; display:flex; align-items:center; justify-content:center; border:2px solid white; }

    .btn-primary { background:var(--accent); color:white; border:none; width:100%; padding:16px; border-radius:12px; font-weight:700; cursor:pointer; margin-top:10px; }
    
    .loader-overlay { position:fixed; inset:0; background:white; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .spinner { width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    @media (max-width:768px) {
      .menu { grid-template-columns: 1fr 1fr; gap:12px; padding:0 12px; }
      .header-title { font-size:20px; }
      .product-name { font-size:15px; }
      .product-price { font-size:16px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-container">
      <div class="logo-wrap">
        <img class="logo-img" src="logo.png" alt="–°–í–û–Ø –ö–£–•–ù–Ø">
        <div>
          <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
          <div class="header-desc">–î–æ–º–∞—à–Ω—è—è –µ–¥–∞ –≤ –ù—è—á–∞–Ω–≥—É</div>
        </div>
      </div>
      <div class="promo-banner">–ú–ï–ù–Æ</div>
    </div>
  </div>

  <div class="menu-controls">
    <button onclick="filterMenu('all')" id="filterAll" class="active">–í—Å–µ –±–ª—é–¥–∞</button>
    <button onclick="filterMenu('favorites')" id="filterFavorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (<span id="favCount">0</span>)</button>
    <button onclick="showOrderHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
  </div>

  <div class="menu" id="menu"></div>

  <button id="cartFab" class="cart-fab" style="display:none;" onclick="showCartModal()">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4zM3 6h18M16 10a4 4 0 0 1-8 0"/></svg>
    <span id="cartFabCount" class="cart-fab-count">0</span>
  </button>

  <div id="cartModal" class="modal-bg"></div>
  <div id="garnishModal" class="modal-bg"></div>
  <div id="historyModal" class="modal-bg"></div>

  <div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-weight:600;">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∫—É—Å–Ω–æ—Å—Ç–∏...</div>
  </div>

  <script>
    const SHEET_API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1RB1WcfHQwfJubjb6Y2XUFtZXOTI2-SHCl09jsyUHk0w/values/menu?key=YOUR_API_KEY';
    // –ò—Å–ø–æ–ª—å–∑—É—é —Ç–≤–æ–π —Ä–∞–±–æ—á–∏–π —Å–∫—Ä–∏–ø—Ç –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫
    const FALLBACK_URL = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';
    
    const TELEGRAM_BOT_TOKEN = '7637734194:AAGLXLycqKlHpi4183_4Jaaaz3bwm_SJXqw';
    const TELEGRAM_CHAT_ID = '7567253745';

    let menuData = [];
    let cart = JSON.parse(localStorage.getItem('cart_v2') || '{}');
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let orderHistory = JSON.parse(localStorage.getItem('orderHistory') || '[]');
    let currentFilter = 'all';

    const FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    async function loadMenu() {
      try {
        const res = await fetch(FALLBACK_URL);
        const data = await res.json();
        
        menuData = data.menu.map((item, idx) => ({
          id: idx + 1,
          name: item.name,
          description: item.description || '',
          price: parseInt(item.price) || 0,
          img: item.img || '',
          available: String(item.available).toLowerCase() === 'true',
          dishDay: String(item.dish_of_day).toLowerCase() === 'true',
          garnishRaw: item.garnish || '' 
        }));

        renderMenu();
        document.getElementById('loader').style.display = 'none';
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      }
    }

    function renderMenu() {
      const container = document.getElementById('menu');
      let items = menuData;
      if (currentFilter === 'favorites') items = menuData.filter(i => favorites.includes(i.id));

      container.innerHTML = items.map(item => {
        const isFav = favorites.includes(item.id);
        const qty = getQtyInCart(item.id);
        return `
          <div class="product ${!item.available ? 'unavailable' : ''}">
            <div class="product-img-wrap">
              ${item.dishDay && item.available ? '<div class="dish-badge">–ë–ª—é–¥–æ –¥–Ω—è</div>' : ''}
              ${!item.available ? '<div class="prod-unavailable">–ë—É–¥–µ—Ç –ø–æ–∑–∂–µ</div>' : ''}
              <button class="favorite-btn" onclick="toggleFav(${item.id})">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
              <img src="${item.img || 'https://via.placeholder.com/300'}" class="product-img">
            </div>
            <div class="product-content">
              <div class="product-name">${item.name}</div>
              <div class="product-desc">${item.description}</div>
              <div class="product-footer">
                <div class="product-price">${FMT.format(item.price)}</div>
                <div class="controls">
                   <button class="remove-btn" onclick="changeQty(${item.id}, -1)">-</button>
                   <span style="font-weight:700; min-width:20px; text-align:center">${qty}</span>
                   <button class="add-btn" onclick="handleAddClick(${item.id})">+</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      updateCartFab();
      document.getElementById('favCount').textContent = favorites.length;
    }

    // –õ–æ–≥–∏–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ "+"
    function handleAddClick(id) {
      const item = menuData.find(i => i.id === id);
      if (item.garnishRaw) {
        showGarnishModal(item);
      } else {
        addToCart(item.id, null);
      }
    }

    function showGarnishModal(item) {
      const garnishes = item.garnishRaw.split(',').map(s => s.trim());
      const modal = document.getElementById('garnishModal');
      
      let html = `
        <div class="modal">
          <button class="modal-close" onclick="closeModal('garnishModal')">&times;</button>
          <div class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–∞—Ä–Ω–∏—Ä –∫ <br><span style="color:var(--accent)">${item.name}</span></div>
          <div class="garnish-grid">`;
      
      garnishes.forEach(gName => {
        // –ò—â–µ–º —Ü–µ–Ω—É –≥–∞—Ä–Ω–∏—Ä–∞ –≤ –æ–±—â–µ–º –º–µ–Ω—é
        const garnishItem = menuData.find(m => m.name.toLowerCase() === gName.toLowerCase());
        const gPrice = garnishItem ? garnishItem.price : 0;
        
        html += `
          <div class="garnish-btn" onclick="addToCart(${item.id}, '${gName}', ${gPrice})">
            <span>${gName}</span>
            <span class="garnish-price">+ ${FMT.format(gPrice)}</span>
          </div>`;
      });

      html += `</div></div>`;
      modal.innerHTML = html;
      modal.classList.add('show');
    }

    function addToCart(mainId, garnishName, garnishPrice = 0) {
      const mainItem = menuData.find(i => i.id === mainId);
      // –ö–ª—é—á —É–Ω–∏–∫–∞–ª–µ–Ω –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ "–ë–ª—é–¥–æ + –ì–∞—Ä–Ω–∏—Ä"
      const cartKey = garnishName ? `${mainId}_${garnishName}` : `${mainId}_none`;

      if (!cart[cartKey]) {
        cart[cartKey] = {
          id: mainId,
          name: mainItem.name,
          garnish: garnishName,
          basePrice: mainItem.price,
          extraPrice: garnishPrice,
          totalPrice: mainItem.price + garnishPrice,
          qty: 0
        };
      }
      cart[cartKey].qty++;
      saveCart();
      renderMenu();
      closeModal('garnishModal');
      if(document.getElementById('cartModal').classList.contains('show')) showCartModal();
    }

    function changeQty(id, delta) {
      // –î–ª—è –∫–Ω–æ–ø–∫–∏ "-" –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ: –Ω–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é —ç—Ç–æ–≥–æ –±–ª—é–¥–∞
      const keys = Object.keys(cart).filter(k => cart[k].id === id);
      if (keys.length === 0) return;
      
      const lastKey = keys[keys.length - 1];
      cart[lastKey].qty += delta;
      if (cart[lastKey].qty <= 0) delete cart[lastKey];
      
      saveCart();
      renderMenu();
      if(document.getElementById('cartModal').classList.contains('show')) showCartModal();
    }

    function getQtyInCart(id) {
      return Object.values(cart).filter(i => i.id === id).reduce((sum, i) => sum + i.qty, 0);
    }

    function saveCart() {
      localStorage.setItem('cart_v2', JSON.stringify(cart));
      updateCartFab();
    }

    function updateCartFab() {
      const count = Object.values(cart).reduce((sum, i) => sum + i.qty, 0);
      const fab = document.getElementById('cartFab');
      fab.style.display = count > 0 ? 'flex' : 'none';
      document.getElementById('cartFabCount').textContent = count;
    }

    function showCartModal() {
      const modal = document.getElementById('cartModal');
      const items = Object.values(cart);
      const total = items.reduce((sum, i) => sum + (i.totalPrice * i.qty), 0);

      modal.innerHTML = `
        <div class="modal">
          <button class="modal-close" onclick="closeModal('cartModal')">&times;</button>
          <div class="modal-title">–í–∞—à –∑–∞–∫–∞–∑</div>
          <ul class="cart-list">
            ${items.map(i => `
              <li>
                <div class="cart-item-info">
                  <strong>${i.name}</strong>
                  ${i.garnish ? `<span class="cart-item-garnish">+ ${i.garnish}</span>` : ''}
                  <span>${FMT.format(i.totalPrice)}</span>
                </div>
                <div class="controls">
                  <button class="remove-btn" onclick="updateCartKey('${i.id}_${i.garnish||'none'}', -1)">-</button>
                  <span>${i.qty}</span>
                  <button class="add-btn" onclick="updateCartKey('${i.id}_${i.garnish||'none'}', 1)">+</button>
                </div>
              </li>
            `).join('')}
          </ul>
          <div style="font-size:20px; font-weight:800; text-align:right; margin-bottom:20px;">
            –ò—Ç–æ–≥–æ: ${FMT.format(total)}
          </div>
          <button class="btn-primary" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å —á–µ—Ä–µ–∑ Telegram</button>
        </div>
      `;
      modal.classList.add('show');
    }

    function updateCartKey(key, delta) {
      if (!cart[key]) return;
      cart[key].qty += delta;
      if (cart[key].qty <= 0) delete cart[key];
      saveCart();
      showCartModal();
      renderMenu();
    }

    async function sendOrder() {
      const items = Object.values(cart);
      const total = items.reduce((sum, i) => sum + (i.totalPrice * i.qty), 0);
      
      let text = `üöÄ *–ù–û–í–´–ô –ó–ê–ö–ê–ó*\n\n`;
      items.forEach(i => {
        text += `‚ñ™Ô∏è *${i.name}* ${i.garnish ? `(+ ${i.garnish})` : ''}\n`;
        text += `   ${i.qty} —à—Ç. x ${FMT.format(i.totalPrice)}\n`;
      });
      text += `\nüí∞ *–ò–¢–û–ì–û: ${FMT.format(total)}*`;

      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      try {
        await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: text, parse_mode: 'Markdown' })
        });
        alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.');
        cart = {};
        saveCart();
        closeModal('cartModal');
        renderMenu();
      } catch(e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞');
      }
    }

    function toggleFav(id) {
      const idx = favorites.indexOf(id);
      if (idx > -1) favorites.splice(idx, 1);
      else favorites.push(id);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      renderMenu();
    }

    function filterMenu(f) {
      currentFilter = f;
      document.querySelectorAll('.menu-controls button').forEach(b => b.classList.remove('active'));
      document.getElementById(f === 'all' ? 'filterAll' : 'filterFavorites').classList.add('active');
      renderMenu();
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    window.onclick = function(e) {
      if (e.target.classList.contains('modal-bg')) e.target.classList.remove('show');
    }

    loadMenu();
  </script>
</body>
</html>
