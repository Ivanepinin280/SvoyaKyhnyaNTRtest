<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-olive:#556B2F;
      --brand-olive-light:#7B8A2F;
      --bg-cream:#f7efe0;
      --accent:#b3611f;
      --muted:#7c6a5c;
      --card-border:#6b7a29;
    }
    html,body{height:100%;margin:0;}
    body {
      background: var(--bg-cream);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      min-height:100vh;
      color:#2b2b2b;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .header {
      text-align:center;
      padding:28px 12px 10px 12px;
      background: linear-gradient(90deg, var(--brand-olive) 0%, var(--brand-olive-light) 100%);
      color: #fff;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 0;
    }
    .header-title { font-size:2.0em; font-weight:800; letter-spacing:1px; text-shadow:0 1px 6px rgba(0,0,0,0.12);}
    .header-desc { color:#fffbe6; font-size:1.02em; font-weight:700; letter-spacing:0.5px; margin-top:6px; opacity:0.95; }
    .tg-info{font-size:.93em;color:#8a7700;background:#fffebc;padding:8px 14px;border-radius:6px;margin:17px 0;}
    .menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap:17px;
      justify-items:center;
      align-items:start;
      grid-auto-rows: 1fr;
      max-width:1100px;
      margin:26px auto 20px;
      padding:0 10px;
      box-sizing:border-box;
    }
    /* MOBILE: 2 cols, tablet 3+, desktop auto-fit */
    @media (max-width:700px) {
      .menu { grid-template-columns: repeat(2, minmax(140px, 1fr)); gap:10px; padding:0 4px; }
    }
    @media (max-width:400px) {
      .header-title{font-size:1.17em;}
      .menu { grid-template-columns: 1fr 1fr; gap:7px; }
      .product{max-width:98vw;}
      .cart-modal{padding:10px 3px 8px 3px;}
    }
    @media (min-width:1200px){
      .menu{grid-template-columns: repeat(4, minmax(220px, 1fr)); max-width:1400px;}
    }
    .product {
      background: #fff;
      border-radius:14px;
      box-shadow:0 4px 18px rgba(0,0,0,0.06);
      width:100%;
      max-width:230px;
      padding:14px 10px 17px;
      display:flex; flex-direction:column; justify-content:space-between;
      border:2px solid var(--card-border);
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      box-sizing:border-box; height:100%;
      position:relative;
      margin: 0 auto;
    }
    .product.unavailable {opacity:.6; pointer-events:none;}
    .product-img {
      width:96px; height:96px; object-fit:cover; border-radius:12px; margin: 0 auto 10px auto; background:#eee;
      border:2px solid var(--brand-olive);
      display: block;
    }
    .product-name {font-size:1.05em; font-weight:700; color:var(--brand-olive); margin-bottom:6px; text-align:center; letter-spacing:1px; text-transform:uppercase;}
    .product-desc {color:var(--muted); font-size:.93em; margin-bottom:6px; text-align:center; min-height:36px; flex: 1 1 auto;}
    .product-price {font-size:1.08em; color:#222; margin-bottom:8px; font-weight:700; letter-spacing:0.5px;}
    .controls { display:flex; align-items:center; gap:7px; flex-wrap:nowrap; justify-content:center;}
    .add-btn, .remove-btn {
      border:none; border-radius:7px; font-size:1em; padding:6px 12px; margin:0 2px; cursor:pointer; transition:filter .12s;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      font-weight:700;
    }
    .add-btn { background:var(--brand-olive); color:#fff; }
    .remove-btn { background:#fff; color:var(--brand-olive); border:1px solid var(--card-border); }
    .cart-fab {
      position:fixed; bottom:15px; right:14px; background:var(--accent); border:none; border-radius:50%;
      color:#fff; width:58px; height:58px; font-size:2em; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:999;
      transition:box-shadow .16s;
      box-shadow:0 4px 18px rgba(0,0,0,0.10);
    }
    .cart-fab-count{
      background:#fff; color:var(--accent); border-radius:50%; width:22px; height:22px; position:absolute;right:8px;top:6px;text-align:center;font-size:.95em;line-height:22px;border:1.2px solid #fff;
    }
    .cart-modal-bg{
      position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.24);z-index:1010;display:flex;align-items:flex-start;justify-content:center;display:none;
    }
    .cart-modal{
      background: var(--bg-cream); border-radius:17px; padding:21px 12px 12px 12px; min-width:275px; max-width:99vw;
      box-shadow:0 12px 36px rgba(0,0,0,0.10); position:relative; font-family: 'PT Sans Narrow', Arial, sans-serif;
      max-height:87vh; overflow-y:auto; margin-top:33px;
      display:flex; flex-direction:column;
    }
    .cart-title { font-size:1.13em; color:var(--brand-olive); margin-bottom:10px; letter-spacing:1px; font-weight:800; }
    .cart-list { list-style:none; padding:0; margin:0 0 10px 0; }
    .cart-list li { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; color:#333; }
    .cart-total { font-size:1.05em; color:#222; margin-bottom:11px; text-align:right; font-weight:800;}
    .cart-close { position:absolute; right:10px; top:8px; font-size:1.5em; color:var(--brand-olive); background:none; border:none; cursor:pointer;}
    .order-form input, .order-form textarea, .order-form select {width:100%; padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; font-size:0.98em;}
    .order-btn {background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 18px; font-size:1.03em; font-weight:800; cursor:pointer; width:100%; margin-top:8px;letter-spacing:1px;}
    .order-success {color:#2e7d32; font-size:1.06em; text-align:center; margin-top:10px;}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
    <div class="header-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã ‚Äî –≤–∫—É—Å–Ω–æ, –±—ã—Å—Ç—Ä–æ, —Ä—è–¥–æ–º</div>
  </div>

  <div class="tg-info">
    <b>–®–∞–≥ 1:</b> –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –±–æ—Ç—É –≤ Telegram: <a href="https://t.me/SvoyaKuhnyaNatrang_bot" target="_blank">@SvoyaKuhnyaNatrang_bot</a>.<br>
    <b>–®–∞–≥ 2:</b> –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π Telegram username (–±–µ–∑ @) –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.<br>
    <i>–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤–∞—à –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω—ë–Ω.</i>
  </div>

  <div class="menu" id="menu"></div>

  <div class="cart-fab" id="cartFab" style="display:none;" title="–ö–æ—Ä–∑–∏–Ω–∞" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
    üõí
    <span id="cartFabCount" class="cart-fab-count"></span>
  </div>

  <div id="cartModalBg" class="cart-modal-bg"></div>

  <script>
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
    const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';
    const TELEGRAM_BOT_TOKEN = '7637734194:AAGLXLycqKlHpi4183_4Jaaaz3bwm_SJXqw';
    const TELEGRAM_OPERATOR_CHAT_ID = '7567253745';
    let menuData = [];
    let cart = {};

    // –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π –¥–æ–Ω–≥ –≤–º–µ—Å—Ç–æ —Ä—É–±–ª—è!
    const VND_FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    async function loadMenu() {
      try {
        const res = await fetch(SHEET_API_FALLBACK);
        const j2 = await res.json();
        if (j2 && j2.menu && Array.isArray(j2.menu)) {
          menuData = j2.menu.map((item, idx) => ({
            id: idx + 1,
            name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
            description: item.description || '',
            img: item.img || '',
            price: Number(item.price) || 0,
            available: String(item.available).trim().toLowerCase() === 'true'
          }));
          renderMenu();
          return;
        }
        document.getElementById('menu').innerHTML = '<div>–ú–µ–Ω—é –ø—É—Å—Ç–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
      } catch (e) {
        document.getElementById('menu').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é.</div>';
      }
    }

    function renderMenu() {
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      if (!menuData || menuData.length === 0) {
        menu.innerHTML = '<div style="color:var(--brand-olive);font-size:1.1em;text-align:center;margin:40px auto;">–ú–µ–Ω—é –ø—É—Å—Ç–æ.</div>';
        updateCartFab();
        return;
      }
      menuData.forEach(item => {
        const prod = document.createElement('div');
        prod.className = 'product' + (!item.available ? ' unavailable' : '');
        const priceText = VND_FMT.format(Number(item.price) || 0);
        prod.innerHTML = `
          <img class="product-img" src="${item.img && item.img.startsWith('http') ? item.img : 'https://via.placeholder.com/96?text=%D0%A4%D0%BE%D1%82%D0%BE'}" alt="${escapeHtml(item.name)}">
          <div class="product-name">${escapeHtml(item.name)}</div>
          <div class="product-desc">${escapeHtml(item.description || '')}</div>
          <div class="product-price">${priceText}</div>
          <div class="controls">
            <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
            <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
            <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
          </div>
        `;
        menu.appendChild(prod);
      });
      updateCartFab();
    }

    window.updateCart = function(id, delta) {
      const item = menuData.find(i=>i.id===id);
      if (!item || !item.available) return;
      if (!cart[id]) cart[id] = { ...item, qty: 0 };
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      const qtyEl = document.getElementById(`qty-${id}`);
      if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
      updateCartFab();
      if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
    };

    function updateCartFab() {
      const fab = document.getElementById('cartFab');
      const count = Object.values(cart).reduce((s,i)=>s + (i.qty || 0), 0);
      if (count > 0) {
        fab.style.display = 'flex';
        document.getElementById('cartFabCount').textContent = count;
      } else {
        fab.style.display = 'none';
        document.getElementById('cartFabCount').textContent = '';
      }
    }

    document.getElementById('cartFab').onclick = showCartModal;

    function showCartModal() {
      const modalBg = document.getElementById('cartModalBg');
      const items = Object.values(cart).sort((a, b) => a.id - b.id);
      const listHtml = items.length === 0
        ? '<li style="color:var(--brand-olive);text-align:center;width:100%;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</li>'
        : items.map(it => `
            <li>
              <span>${escapeHtml(it.name)} x${it.qty}</span>
              <span>
                <button class="remove-btn" onclick="updateCart(${it.id},-1)">‚àí</button>
                <span style="margin:0 8px;">${VND_FMT.format((it.price||0) * it.qty)}</span>
                <button class="add-btn" onclick="updateCart(${it.id},1)">+</button>
              </span>
            </li>
          `).join('');
      const total = items.reduce((s,i)=>s + (i.price || 0) * i.qty, 0);
      modalBg.innerHTML = `
        <div class="cart-modal" role="dialog" aria-modal="true" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
          <button class="cart-close" onclick="closeCartModal()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
          <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          <ul class="cart-list">${listHtml}</ul>
          <div class="cart-total">–ò—Ç–æ–≥–æ: ${VND_FMT.format(total)}</div>
          <form class="order-form" id="orderForm">
            <input type="text" id="name" placeholder="–í–∞—à Telegram username (–±–µ–∑ @)" required>
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
            <select id="payment">
              <option value="">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
              <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
              <option value="qr">QR (–æ–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫–∞–Ω)</option>
            </select>
            <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="2"></textarea>
            <button type="submit" class="order-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div id="orderSuccess" class="order-success" style="display:none;"></div>
          </form>
        </div>
      `;
      modalBg.style.display = 'flex';
      const orderForm = document.getElementById('orderForm');
      if (orderForm) orderForm.onsubmit = sendOrder;
      setTimeout(() => {
        const modal = document.querySelector('.cart-modal');
        if (modal) modal.scrollIntoView({behavior: "smooth", block: "start"});
      }, 40);
    }

    window.closeCartModal = function() {
      document.getElementById('cartModalBg').style.display = 'none';
    };

    async function sendOrder(e) {
      e.preventDefault();
      const btn = document.querySelector('.order-btn');
      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      const name = document.getElementById('name').value.trim(); // username –±–µ–∑ @ !
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.getElementById('payment').value;
      const comment = document.getElementById('comment').value.trim();

      if (!name || !phone || !address) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return;
      }
      const itemsArr = Object.values(cart);
      if (itemsArr.length === 0) { alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
      const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty,0);
      let orderLines = itemsArr.map(i=>`${i.name} x${i.qty} ‚Äî ${VND_FMT.format(i.price * i.qty)}`).join('\n');
      let paymentText = payment==='cash' ? '–û–ø–ª–∞—Ç–∞: –ù–∞–ª–∏—á–Ω—ã–µ' : payment==='qr' ? '–û–ø–ª–∞—Ç–∞: QR' : '';
      const orderId = 'order_' + Math.random().toString(36).substr(2,9);
      const text =
        `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ (–°–í–û–Ø –ö–£–•–ù–Ø)\n` +
        `Telegram username: @${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n` +
        (paymentText?paymentText+'\n':'') +
        (comment?`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n`:'') +
        `\n–ó–∞–∫–∞–∑:\n${orderLines}\n\n–°—É–º–º–∞: ${VND_FMT.format(total)}`;

      // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏, –≥–¥–µ –≤ data username!
      const msg = {
        chat_id: TELEGRAM_OPERATOR_CHAT_ID,
        text,
        reply_markup: JSON.stringify({
          inline_keyboard: [
            [
              {text: "‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data: `accept_${name}_${orderId}`},
              {text: "‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data: `decline_${name}_${orderId}`}
            ]
          ]
        })
      };
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(msg)
        });
        const result = await response.json();
        if (result.ok) {
          btn.style.display = 'none';
          document.getElementById('orderSuccess').style.display = 'block';
          document.getElementById('orderSuccess').textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞.';
          cart = {};
          setTimeout(()=>{ closeCartModal(); renderMenu(); }, 1400);
        } else {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      }
    }

    // run
    loadMenu();
  </script>
</body>
</html>
