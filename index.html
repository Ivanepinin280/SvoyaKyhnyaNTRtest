<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #1a1a1a;
      --primary-light: #2d2d2d;
      --accent: #ff6b35;
      --accent-hover: #ff5722;
      --bg: #fafafa;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --text-light: #666666;
      --text-muted: #999999;
      --border: #e5e5e5;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
    }
    
    * { box-sizing:border-box; margin:0; padding:0; }
    
    html,body{
      height:100%;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      overflow-x: hidden;
    }

    .header {
      background:var(--card-bg);
      padding:32px 20px 24px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(20px);
      background:rgba(255,255,255,0.95);
    }
    
    .header-container { max-width:1200px; margin:0 auto; }
    
    .logo-wrap { display:flex; align-items:center; gap:16px; margin-bottom:20px; }
    .logo-img { width:64px; height:64px; border-radius:16px; object-fit:cover; box-shadow:var(--shadow-md); }
    .header-title { font-size:28px; font-weight:800; color:var(--primary); letter-spacing:-0.5px; line-height:1.2; }
    .header-desc { font-size:14px; color:var(--text-light); font-weight:500; margin-top:4px; }
    
    .promo-banner {
      background:linear-gradient(135deg, var(--accent) 0%, #ff8a65 100%);
      padding:12px 20px; border-radius:var(--radius-sm);
      text-align:center; color:white; font-weight:600; font-size:14px; box-shadow:var(--shadow-md);
    }

    .menu-controls { max-width:1200px; margin:24px auto 16px; padding:0 20px; display:flex; gap:12px; flex-wrap:wrap; }
    .menu-controls button {
      background:white; color:var(--text); border:2px solid var(--border); border-radius:var(--radius-sm);
      padding:10px 20px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.3s;
    }
    .menu-controls button.active { background:var(--primary); color:white; border-color:var(--primary); }

    .menu {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:24px; max-width:1200px; margin:0 auto 120px; padding:0 20px;
    }

    .product {
      background:var(--card-bg); border-radius:var(--radius-md); overflow:hidden;
      position:relative; border:1px solid var(--border); transition:all 0.4s; display:flex; flex-direction:column;
    }
    .product:hover { transform:translateY(-8px); box-shadow:var(--shadow-lg); }
    .product.unavailable { opacity: 0.6; }
    
    .product-img-wrap { position:relative; width:100%; height:200px; overflow:hidden; background:#eee; }
    .product-img { width:100%; height:100%; object-fit:cover; cursor:pointer; transition:transform 0.5s; }
    .product:hover .product-img { transform:scale(1.08); }

    .dish-badge {
      position: absolute; top: 0; left: 16px; z-index: 20;
      background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%);
      color: #fff; padding: 10px 10px 12px; font-weight: 800; font-size: 10px;
      text-transform: uppercase; border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(255, 140, 0, 0.5);
      display: flex; flex-direction: column; align-items: center; line-height: 1.2;
    }

    .favorite-btn {
      position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.95);
      border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center;
      justify-content:center; cursor:pointer; font-size:20px; z-index:10; transition:all 0.3s;
    }

    .product-content { padding:20px; flex:1; display:flex; flex-direction:column; }
    .product-name { font-size:18px; font-weight:700; margin-bottom:8px; line-height:1.3; }
    .product-desc { color:var(--text-light); font-size:14px; line-height:1.5; margin-bottom:16px; flex:1; }
    
    .product-footer { display:flex; align-items:center; justify-content:space-between; padding-top:16px; border-top:1px solid var(--border); }
    .product-price { font-size:20px; font-weight:700; }
    
    .add-btn {
      background:var(--accent); color:white; border:none; border-radius:8px;
      width:40px; height:40px; cursor:pointer; font-size:20px; font-weight:600; transition:0.2s;
    }
    .add-btn:hover { background:var(--accent-hover); transform:scale(1.05); }

    /* FAB –ö–æ—Ä–∑–∏–Ω–∞ */
    .cart-fab {
      position:fixed; bottom:24px; right:24px; background:var(--primary);
      width:72px; height:72px; border-radius:50%; cursor:pointer; z-index:900;
      display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    .cart-fab-count {
      position:absolute; right:-2px; top:-2px; background:var(--accent); color:white;
      font-weight:800; border-radius:50%; min-width:30px; height:30px;
      display:flex; align-items:center; justify-content:center; border:3px solid var(--bg);
    }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal-bg {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
      backdrop-filter:blur(4px); z-index:1000; align-items:flex-start; justify-content:center;
      overflow-y:auto; padding:20px;
    }
    .modal-bg.show { display:flex; }
    .modal {
      background:white; border-radius:var(--radius-lg); padding:32px;
      max-width:560px; width:100%; position:relative; margin:40px auto;
      animation:modalSlideUp 0.3s ease;
    }
    @keyframes modalSlideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .modal-close { position:absolute; right:16px; top:16px; font-size:28px; border:none; cursor:pointer; background:none; }

    /* –í—ã–±–æ—Ä –≥–∞—Ä–Ω–∏—Ä–∞ */
    .garnish-grid { display: grid; gap: 10px; margin-top: 20px; }
    .garnish-option {
      padding: 16px; border: 2px solid var(--border); border-radius: var(--radius-sm);
      cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s;
    }
    .garnish-option:hover { border-color: var(--accent); background: #fffaf8; }

    /* –ö–æ—Ä–∑–∏–Ω–∞ —Å–ø–∏—Å–æ–∫ */
    .cart-list { list-style:none; margin-bottom: 20px; }
    .cart-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; background:var(--bg); border-radius:var(--radius-sm); margin-bottom:8px;
    }
    .cart-item-info { flex:1; }
    .cart-item-garnish { font-size:12px; color:var(--accent); font-weight:600; }

    .btn-primary {
      background:var(--accent); color:white; border:none; border-radius:var(--radius-sm);
      padding:16px; font-size:16px; font-weight:700; cursor:pointer; width:100%;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loader-overlay { position:fixed; inset:0; background:white; z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; }
    .spinner { width:48px; height:48px; border:4px solid #f3f3f3; border-top:4px solid var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    @media (max-width:768px) {
      .menu { grid-template-columns: 1fr 1fr; gap:12px; padding:0 12px; }
      .product-img-wrap { height:150px; }
      .product-name { font-size:15px; }
      .modal { padding: 20px; }
    }
  </style>
</head>
<body>

  <div id="loader" class="loader-overlay">
    <div class="spinner"></div>
    <div style="margin-top:20px; font-weight:600;">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é...</div>
  </div>

  <div class="header">
    <div class="header-container">
      <div class="logo-wrap">
        <img class="logo-img" src="logo.png" alt="Logo">
        <div>
          <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
          <div class="header-desc">–î–æ–º–∞—à–Ω—è—è –µ–¥–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –≤ –ù—è—á–∞–Ω–≥–µ</div>
        </div>
      </div>
      <div class="promo-banner">üç± –°–í–ï–ñ–ï–ï –ú–ï–ù–Æ –ù–ê –°–ï–ì–û–î–ù–Ø</div>
    </div>
  </div>

  <div class="menu-controls">
    <button onclick="filterMenu('all')" class="active" id="filterAll">–í—Å–µ –±–ª—é–¥–∞</button>
    <button onclick="filterMenu('favorites')" id="filterFavorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (<span id="favCount">0</span>)</button>
    <button onclick="showOrderHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
  </div>

  <div class="menu" id="menu"></div>

  <div id="cartFab" class="cart-fab" style="display:none;" onclick="showCartModal()">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
      <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4H6zM3 6h18M16 10a4 4 0 01-8 0"/>
    </svg>
    <span id="cartFabCount" class="cart-fab-count">0</span>
  </div>

  <div id="garnishModal" class="modal-bg"></div>
  <div id="cartModal" class="modal-bg"></div>
  <div id="historyModal" class="modal-bg"></div>
  <div id="deliveryModal" class="modal-bg"></div>

  <script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';
    const BOT_TOKEN = '7637734194:AAGLXLycqKlHpi4183_4Jaaaz3bwm_SJXqw';
    const CHAT_ID = '7567253745';

    let menuData = [];
    let cart = JSON.parse(localStorage.getItem('cart_v3') || '[]'); 
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let orderHistory = JSON.parse(localStorage.getItem('orderHistory') || '[]');
    let currentFilter = 'all';

    const FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã
    async function loadMenu() {
      try {
        const res = await fetch(SHEET_URL);
        const data = await res.json();
        
        menuData = data.menu.map((item, idx) => ({
          id: idx + 1,
          name: item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
          price: parseFloat(item.price) || 0,
          description: item.description || '',
          img: item.img || '',
          available: String(item.available).toLowerCase() !== 'false',
          dishDay: String(item.dish_of_day).toLowerCase() === 'true',
          // –°—á–∏—Ç—ã–≤–∞–µ–º –≥–∞—Ä–Ω–∏—Ä—ã –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ garnish
          garnishes: item.garnish ? item.garnish.split(',').map(s => s.trim()).filter(s => s) : []
        }));
        
        renderMenu();
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    function renderMenu() {
      const container = document.getElementById('menu');
      let items = currentFilter === 'favorites' ? menuData.filter(i => favorites.includes(i.id)) : menuData;

      container.innerHTML = items.map(item => {
        const isFav = favorites.includes(item.id);
        return `
        <div class="product ${!item.available ? 'unavailable' : ''}">
          <div class="product-img-wrap">
            ${item.dishDay ? '<div class="dish-badge"><span>‚òÖ</span>–ë–õ–Æ–î–û –î–ù–Ø</div>' : ''}
            <button class="favorite-btn" onclick="toggleFav(${item.id})">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
            <img class="product-img" src="${item.img || 'https://via.placeholder.com/300'}" alt="">
          </div>
          <div class="product-content">
            <div class="product-name">${item.name}</div>
            <div class="product-desc">${item.description}</div>
            <div class="product-footer">
              <div class="product-price">${FMT.format(item.price)}</div>
              <button class="add-btn" onclick="handleAddClick(${item.id})">+</button>
            </div>
          </div>
        </div>
      `}).join('');
      updateUI();
    }

    // –õ–û–ì–ò–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø
    function handleAddClick(id) {
      const item = menuData.find(i => i.id === id);
      if (!item || !item.available) return;

      // –ï—Å–ª–∏ –µ—Å—Ç—å –≥–∞—Ä–Ω–∏—Ä—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      if (item.garnishes.length > 0) {
        showGarnishModal(item);
      } else {
        addToCart(item, null);
      }
    }

    function showGarnishModal(item) {
      const modal = document.getElementById('garnishModal');
      modal.innerHTML = `
        <div class="modal">
          <button class="modal-close" onclick="closeModal('garnishModal')">&times;</button>
          <div style="font-size:22px; font-weight:800; margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ –≥–∞—Ä–Ω–∏—Ä</div>
          <div style="color:var(--text-light); margin-bottom:20px;">–î–ª—è –±–ª—é–¥–∞: <b>${item.name}</b></div>
          <div class="garnish-grid">
            ${item.garnishes.map(g => `
              <div class="garnish-option" onclick="confirmGarnish(${item.id}, '${g}')">${g}</div>
            `).join('')}
          </div>
        </div>
      `;
      modal.classList.add('show');
    }

    window.confirmGarnish = (id, garnish) => {
      const item = menuData.find(i => i.id === id);
      addToCart(item, garnish);
      closeModal('garnishModal');
    };

    function addToCart(item, garnish) {
      // –ö–ª—é—á —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏: ID + –ì–∞—Ä–Ω–∏—Ä
      const existing = cart.find(c => c.id === item.id && c.garnish === garnish);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({
          id: item.id,
          name: item.name,
          price: item.price,
          garnish: garnish,
          qty: 1
        });
      }
      saveCart();
      updateUI();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      saveCart();
      showCartModal();
      updateUI();
    }

    function saveCart() { localStorage.setItem('cart_v3', JSON.stringify(cart)); }

    function updateUI() {
      const count = cart.reduce((s, i) => s + i.qty, 0);
      document.getElementById('cartFab').style.display = count > 0 ? 'flex' : 'none';
      document.getElementById('cartFabCount').textContent = count;
      document.getElementById('favCount').textContent = favorites.length;
    }

    // –ö–û–†–ó–ò–ù–ê –ò –û–§–û–†–ú–õ–ï–ù–ò–ï
    function showCartModal() {
      const modal = document.getElementById('cartModal');
      const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
      const savedUser = JSON.parse(localStorage.getItem('userData') || '{}');

      modal.innerHTML = `
        <div class="modal">
          <button class="modal-close" onclick="closeModal('cartModal')">&times;</button>
          <div style="font-size:24px; font-weight:800; margin-bottom:20px;">–í–∞—à –∑–∞–∫–∞–∑</div>
          
          <div class="cart-list">
            ${cart.map((item, idx) => `
              <div class="cart-item">
                <div class="cart-item-info">
                  <div style="font-weight:700;">${item.name}</div>
                  ${item.garnish ? `<div class="cart-item-garnish">–ì–∞—Ä–Ω–∏—Ä: ${item.garnish}</div>` : ''}
                  <div style="font-size:13px;">${item.qty} —à—Ç. x ${FMT.format(item.price)}</div>
                </div>
                <button onclick="removeFromCart(${idx})" style="color:red; border:none; background:none; cursor:pointer; font-weight:600;">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `).join('')}
          </div>

          <div style="font-size:20px; font-weight:800; text-align:right; margin-bottom:20px;">–ò—Ç–æ–≥–æ: ${FMT.format(total)}</div>

          <form onsubmit="sendOrder(event)">
            <div class="form-group">
              <label>Telegram –ù–∏–∫–Ω–µ–π–º / –ò–º—è</label>
              <input type="text" id="userName" required value="${savedUser.name || ''}" placeholder="@username">
            </div>
            <div class="form-group">
              <label>–ê–¥—Ä–µ—Å (–û—Ç–µ–ª—å –∏ –Ω–æ–º–µ—Ä –∫–æ–º–Ω–∞—Ç—ã)</label>
              <div style="display:flex; gap:5px;">
                <input type="text" id="userAddr" required value="${savedUser.addr || ''}" placeholder="–ù–∞–ø—Ä. Maple Hotel, 1204">
                <button type="button" onclick="getLocation()" style="background:#eee; border:none; border-radius:8px; padding:0 10px;">üìç</button>
              </div>
            </div>
            <button type="submit" class="btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
          </form>
        </div>
      `;
      modal.classList.add('show');
    }

    async function sendOrder(e) {
      e.preventDefault();
      const name = document.getElementById('userName').value;
      const addr = document.getElementById('userAddr').value;
      const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);

      localStorage.setItem('userData', JSON.stringify({name, addr}));

      let text = `üöÄ *–ù–û–í–´–ô –ó–ê–ö–ê–ó*\n\n`;
      text += `üë§ *–ö–ª–∏–µ–Ω—Ç:* ${name}\n`;
      text += `üìç *–ê–¥—Ä–µ—Å:* ${addr}\n\n`;
      text += `üì¶ *–ó–∞–∫–∞–∑:* \n`;
      
      cart.forEach(i => {
        text += `‚Ä¢ ${i.name} ${i.garnish ? `_(–ì–∞—Ä–Ω–∏—Ä: ${i.garnish})_` : ''} ‚Äî ${i.qty} —à—Ç.\n`;
      });
      
      text += `\nüí∞ *–ò–¢–û–ì–û: ${FMT.format(total)}*`;

      try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: CHAT_ID, text: text, parse_mode: 'Markdown' })
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        orderHistory.unshift({ date: new Date().toLocaleString(), total, items: [...cart] });
        localStorage.setItem('orderHistory', JSON.stringify(orderHistory.slice(0, 10)));

        alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ Telegram.');
        cart = [];
        saveCart();
        location.reload();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
      }
    }

    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    function toggleFav(id) {
      const idx = favorites.indexOf(id);
      if (idx > -1) favorites.splice(idx, 1);
      else favorites.push(id);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      renderMenu();
    }

    function filterMenu(f) {
      currentFilter = f;
      document.querySelectorAll('.menu-controls button').forEach(b => b.classList.remove('active'));
      document.getElementById(f === 'all' ? 'filterAll' : 'filterFavorites').classList.add('active');
      renderMenu();
    }

    function showOrderHistory() {
      const modal = document.getElementById('historyModal');
      modal.innerHTML = `
        <div class="modal">
          <button class="modal-close" onclick="closeModal('historyModal')">&times;</button>
          <div style="font-size:22px; font-weight:800; margin-bottom:20px;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
          ${orderHistory.length === 0 ? '<p>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>' : orderHistory.map(h => `
            <div style="background:#f9f9f9; padding:12px; border-radius:12px; margin-bottom:10px; font-size:14px;">
              <div style="font-weight:700;">${h.date}</div>
              <div style="color:var(--text-light);">${h.items.map(i => i.name).join(', ')}</div>
              <div style="font-weight:700; color:var(--accent); margin-top:5px;">${FMT.format(h.total)}</div>
            </div>
          `).join('')}
        </div>
      `;
      modal.classList.add('show');
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          document.getElementById('userAddr').value = `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${pos.coords.latitude}, ${pos.coords.longitude}`;
        });
      }
    }

    window.closeModal = (id) => document.getElementById(id).classList.remove('show');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
    window.onclick = (e) => { if (e.target.classList.contains('modal-bg')) e.target.classList.remove('show'); };

    loadMenu();
  </script>
</body>
</html>
