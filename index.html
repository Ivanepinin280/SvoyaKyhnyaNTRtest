<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary: #1a1a1a;
      --primary-light: #2d2d2d;
      --accent: #ff6b35;
      --accent-hover: #ff5722;
      --bg: #fafafa;
      --card-bg: #ffffff;
      --text: #1a1a1a;
      --text-light: #666666;
      --text-muted: #999999;
      --border: #e5e5e5;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
    }
    
    * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
    
    html,body{
      height:100%;
      font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }

    .header {
      background:var(--card-bg);
      padding:32px 20px 24px;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(20px);
      background:rgba(255,255,255,0.95);
    }
    
    .header-container {
      max-width:1200px;
      margin:0 auto;
    }
    
    .logo-wrap {
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:20px;
    }
    
    .logo-img {
      width:64px;
      height:64px;
      border-radius:16px;
      object-fit:cover;
      box-shadow:var(--shadow-md);
    }
    
    .header-title {
      font-size:28px;
      font-weight:800;
      color:var(--primary);
      letter-spacing:-0.5px;
      line-height:1.2;
    }
    
    .header-desc {
      font-size:14px;
      color:var(--text-light);
      font-weight:500;
      margin-top:4px;
    }
    
    .promo-banner {
      background:linear-gradient(135deg, var(--accent) 0%, #ff8a65 100%);
      padding:12px 20px;
      border-radius:var(--radius-sm);
      text-align:center;
      color:white;
      font-weight:600;
      font-size:14px;
      letter-spacing:0.5px;
      box-shadow:var(--shadow-md);
    }

    .menu-controls {
      max-width:1200px;
      margin:24px auto 16px;
      padding:0 20px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    
    .menu-controls button {
      background:white;
      color:var(--text);
      border:2px solid var(--border);
      border-radius:var(--radius-sm);
      padding:10px 20px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      font-family:'Inter', sans-serif;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display:flex;
      align-items:center;
      gap:6px;
    }
    
    .menu-controls button:hover {
      border-color:var(--accent);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }
    
    .menu-controls button.active {
      background:var(--primary);
      color:white;
      border-color:var(--primary);
    }

    .menu {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:24px;
      max-width:1200px;
      margin:0 auto 120px;
      padding:0 20px;
    }

    .product {
      background:var(--card-bg);
      border-radius:var(--radius-md);
      overflow:hidden;
      position:relative;
      border:1px solid var(--border);
      transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display:flex;
      flex-direction:column;
    }
    
    .product:hover {
      transform:translateY(-8px);
      box-shadow:var(--shadow-lg);
      border-color:transparent;
    }
    
    .product.unavailable {
      opacity:0.6;
      filter:grayscale(40%);
    }
    
    .product.unavailable .add-btn,
    .product.unavailable .remove-btn {
      opacity:0.4;
      cursor:not-allowed;
      pointer-events:none;
    }
    
    .product-img-wrap {
      position:relative;
      width:100%;
      height:200px;
      overflow:hidden;
      background:linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%);
    }
    
    .favorite-btn {
      position:absolute;
      top:12px;
      right:12px;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:20px;
      z-index:10;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:var(--shadow-md);
    }
    
    .favorite-btn:hover {
      transform:scale(1.1);
      box-shadow:var(--shadow-lg);
    }
    
    .favorite-btn.active {
      background:rgba(255,107,53,0.1);
    }
    
    .product-img {
      width:100%;
      height:100%;
      object-fit:cover;
      cursor:pointer;
      transition:transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .product:hover .product-img {
      transform:scale(1.08);
    }
    
    .product-content {
      padding:20px;
      flex:1;
      display:flex;
      flex-direction:column;
    }
    
    .product-name {
      font-size:18px;
      font-weight:700;
      color:var(--primary);
      margin-bottom:8px;
      line-height:1.3;
      letter-spacing:-0.3px;
    }
    
    .product-desc {
      color:var(--text-light);
      font-size:14px;
      line-height:1.5;
      margin-bottom:16px;
      flex:1;
      min-height:40px;
    }
    
    .product-footer {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 20px;
      border-top:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,0.6), transparent);
      /* ensure footer elements are on top on small screens */
      position:relative;
      z-index:6;
    }
    
    .product-price {
      font-size:20px;
      font-weight:700;
      color:var(--primary);
      letter-spacing:-0.5px;
    }
    
    .controls {
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--bg);
      padding:6px;
      border-radius:var(--radius-sm);
      /* make sure controls are accessible and not clipped */
      position:relative;
      z-index:8;
    }
    
    .add-btn, .remove-btn {
      border:none;
      border-radius:8px;
      font-size:18px;
      width:36px;
      height:36px;
      cursor:pointer;
      font-family:'Inter', sans-serif;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.12s;
      line-height:1;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .add-btn {
      background:var(--accent);
      color:white;
    }
    
    .add-btn:hover {
      background:var(--accent-hover);
      transform:scale(1.05);
    }
    
    .remove-btn {
      background:white;
      color:var(--text);
      border:1px solid var(--border);
    }
    
    .remove-btn:hover {
      background:var(--bg);
    }
    
    .controls span {
      min-width:32px;
      text-align:center;
      font-weight:700;
      color:var(--text);
      font-size:15px;
    }

    /* Improve tap area and icon visibility on mobile */
    .add-btn, .remove-btn {
      font-size:20px;
      width:44px;
      height:44px;
      border-radius:10px;
    }

    .cart-fab {
      position:fixed;
      bottom:24px;
      right:24px;
      background:var(--primary);
      border:none;
      width:68px;
      height:68px;
      border-radius:50%;
      cursor:pointer;
      z-index:100;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.24);
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .cart-fab:hover {
      transform:scale(1.1);
      box-shadow:0 12px 48px rgba(0,0,0,0.3);
    }
    
    .cart-fab svg {
      width:32px;
      height:32px;
    }
    
    .cart-fab-count {
      position:absolute;
      right:-4px;
      top:-4px;
      background:var(--accent);
      color:white;
      font-weight:700;
      border-radius:50%;
      min-width:28px;
      height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      box-shadow:0 4px 12px rgba(255,107,53,0.4);
      border:3px solid var(--bg);
      pointer-events:none;
    }

    .cart-preview {
      display:none;
      position:absolute;
      bottom:80px;
      right:0;
      background:white;
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      padding:16px;
      min-width:280px;
      max-width:320px;
      box-shadow:var(--shadow-lg);
      pointer-events:none;
    }
    
    .cart-preview-title {
      font-weight:700;
      color:var(--primary);
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
      font-size:15px;
    }
    
    .cart-preview-item {
      display:flex;
      justify-content:space-between;
      margin:8px 0;
      font-size:13px;
      color:var(--text-light);
    }
    
    .cart-preview-total {
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border);
      font-weight:700;
      text-align:right;
      color:var(--primary);
      font-size:15px;
    }

    .modal-bg {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      backdrop-filter:blur(4px);
      z-index:200;
      align-items:flex-start;
      justify-content:center;
      overflow-y:auto;
      padding:20px;
    }
    
    .modal-bg.show {
      display:flex;
    }
    
    .modal {
      background:white;
      border-radius:var(--radius-lg);
      padding:32px;
      max-width:560px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      position:relative;
      margin:40px auto;
      max-height:85vh;
      overflow-y:auto;
      animation:modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalSlideUp {
      from {
        opacity:0;
        transform:translateY(20px);
      }
      to {
        opacity:1;
        transform:translateY(0);
      }
    }
    
    .modal-close {
      position:absolute;
      right:16px;
      top:16px;
      font-size:28px;
      color:var(--text-light);
      background:var(--bg);
      border:none;
      cursor:pointer;
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
    }
    
    .modal-close:hover {
      background:var(--border);
      transform:rotate(90deg);
    }
    
    .modal-title {
      font-size:24px;
      color:var(--primary);
      margin-bottom:24px;
      font-weight:800;
      letter-spacing:-0.5px;
    }

    .cart-list {
      list-style:none;
      padding:0;
      margin:0 0 20px;
    }
    
    .cart-list li {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      padding:16px;
      background:var(--bg);
      border-radius:var(--radius-sm);
    }
    
    .cart-total {
      font-size:20px;
      font-weight:800;
      text-align:right;
      margin-bottom:24px;
      color:var(--primary);
      padding:16px;
      background:var(--bg);
      border-radius:var(--radius-sm);
    }

    .form-group {
      margin-bottom:16px;
    }
    
    .form-group label {
      display:block;
      font-weight:600;
      margin-bottom:8px;
      color:var(--primary);
      font-size:14px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width:100%;
      padding:14px 16px;
      border-radius:var(--radius-sm);
      border:2px solid var(--border);
      font-size:15px;
      background:white;
      font-family:'Inter', sans-serif;
      transition:all 0.2s;
      color:var(--text);
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(255,107,53,0.1);
    }
    
    .form-group textarea {
      resize:vertical;
      min-height:80px;
    }
    
    .geo-group {
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    
    .geo-group input {
      flex:1;
    }
    
    .geo-btn {
      background:var(--primary);
      color:white;
      border:none;
      border-radius:var(--radius-sm);
      padding:14px 16px;
      cursor:pointer;
      font-size:20px;
      flex-shrink:0;
      height:51px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s;
    }
    
    .geo-btn:hover {
      background:var(--primary-light);
      transform:scale(1.05);
    }
    
    .geo-btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
      transform:scale(1);
    }

    .info-box {
      background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border:2px solid #ffb74d;
      border-radius:var(--radius-sm);
      padding:14px;
      margin-bottom:16px;
      font-size:13px;
      color:#e65100;
      text-align:center;
      font-weight:500;
    }

    .delivery-info-btn {
      background:var(--primary);
      color:white;
      border:none;
      border-radius:var(--radius-sm);
      padding:14px;
      width:100%;
      font-weight:600;
      cursor:pointer;
      margin-bottom:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-family:'Inter', sans-serif;
      font-size:14px;
      transition:all 0.2s;
    }
    
    .delivery-info-btn:hover {
      background:var(--primary-light);
      transform:translateY(-2px);
      box-shadow:var(--shadow-md);
    }

    .delivery-info-content {
      background:var(--bg);
      border:2px solid var(--border);
      border-radius:var(--radius-sm);
      padding:20px;
      font-size:14px;
      line-height:1.6;
      color:var(--text-light);
    }
    
    .delivery-info-content strong {
      color:var(--primary);
      display:block;
      margin-bottom:12px;
      font-size:15px;
    }
    
    .delivery-time {
      background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      padding:12px;
      border-radius:var(--radius-sm);
      margin:12px 0;
      color:#2e7d32;
      text-align:center;
      font-weight:600;
    }

    .btn-primary {
      background:var(--accent);
      color:white;
      border:none;
      border-radius:var(--radius-sm);
      padding:16px 24px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      width:100%;
      font-family:'Inter', sans-serif;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .btn-primary:hover {
      background:var(--accent-hover);
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(255,107,53,0.3);
    }

    .history-item {
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      padding:20px;
      margin-bottom:16px;
      transition:all 0.2s;
    }
    
    .history-item:hover {
      box-shadow:var(--shadow-md);
    }
    
    .history-header {
      display:flex;
      justify-content:space-between;
      font-weight:700;
      color:var(--primary);
      margin-bottom:12px;
      font-size:15px;
    }
    
    .history-products {
      font-size:13px;
      color:var(--text-light);
      margin-bottom:12px;
      line-height:1.6;
    }
    
    .history-footer {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    
    .btn-repeat {
      background:var(--accent);
      color:white;
      border:none;
      border-radius:8px;
      padding:8px 16px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition:all 0.2s;
    }
    
    .btn-repeat:hover {
      background:var(--accent-hover);
      transform:translateY(-2px);
    }

    .image-modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.95);
      z-index:300;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter:blur(10px);
    }
    
    .image-modal.show {
      display:flex;
    }
    
    .image-modal img {
      max-width:90vw;
      max-height:90vh;
      border-radius:var(--radius-md);
      box-shadow:0 20px 80px rgba(0,0,0,0.8);
    }

    .prod-unavailable {
      position:absolute;
      left:12px;
      right:12px;
      top:12px;
      background:var(--accent);
      color:white;
      font-size:12px;
      border-radius:8px;
      padding:8px 12px;
      text-align:center;
      z-index:6;
      font-weight:600;
      letter-spacing:0.5px;
      box-shadow:var(--shadow-md);
    }

    .spinner {
      width:48px;
      height:48px;
      border:4px solid rgba(0,0,0,0.1);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform:rotate(360deg);
      }
    }

    .loader-overlay {
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.98);
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
    }
    
    .loader-text {
      margin-top:20px;
      color:var(--primary);
      font-weight:600;
      font-size:16px;
    }

    .processing {
      text-align:center;
      padding:32px;
      color:var(--primary);
    }
    
    .processing-text {
      font-size:16px;
      font-weight:600;
      margin:12px 0;
    }

    .debug-panel {
      position:fixed;
      bottom:100px;
      left:10px;
      background:rgba(0,0,0,0.9);
      color:white;
      padding:12px;
      border-radius:var(--radius-sm);
      font-size:11px;
      max-width:320px;
      z-index:150;
      display:none;
      white-space:pre-wrap;
      word-break:break-word;
    }

    @media (max-width:768px) {
      .menu {
        grid-template-columns:repeat(2,1fr);
        gap:16px;
        margin-bottom:140px;
        padding:0 16px;
      }
      
      .product-img-wrap {
        height:160px;
      }
      
      .product-content {
        padding:16px;
      }
      
      .modal {
        width:100%;
        padding:24px;
        margin:20px 0;
      }
      
      .header-title {
        font-size:22px;
      }
      
      .cart-fab {
        width:60px;
        height:60px;
        bottom:20px;
        right:20px;
      }
      
      .cart-preview {
        bottom:75px;
        max-width:280px;
      }
      
      .menu-controls {
        padding:0 16px;
      }

      /* On mobile increase tap target and ensure icons visible */
      .add-btn, .remove-btn {
        width:48px;
        height:48px;
        font-size:22px;
      }

      .product-footer {
        padding:12px 14px;
      }

      .controls {
        padding:8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-container">
      <div class="logo-wrap">
        <img class="logo-img" src="logo.png" alt="–°–í–û–Ø –ö–£–•–ù–Ø">
        <div>
          <div class="header-title">–°–í–û–Ø –ö–£–•–ù–Ø</div>
          <div class="header-desc">–°–≤–µ–∂–∞—è –¥–æ–º–∞—à–Ω—è—è –µ–¥–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –ø–æ –ù—è—á–∞–Ω–≥—É</div>
        </div>
      </div>
      <div class="promo-banner">
        ‚òÖ –ú–ï–ù–Æ ‚òÖ
      </div>
    </div>
  </div>

  <div class="menu-controls">
    <button onclick="filterMenu('all')" class="active" id="filterAll">–í—Å–µ –±–ª—é–¥–∞</button>
    <button onclick="filterMenu('favorites')" id="filterFavorites">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (<span id="favCount">0</span>)</button>
    <button onclick="showOrderHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è (<span id="historyCount">0</span>)</button>
  </div>

  <div class="menu" id="menu"></div>

  <div id="loader" class="loader-overlay" aria-hidden="false">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</div>
  </div>

  <div id="debugPanel" class="debug-panel" aria-hidden="true"></div>

  <button id="cartFab" class="cart-fab" style="display:none;" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
    <svg viewBox="0 0 48 48" fill="none" aria-hidden="true">
      <path d="M16 18h16l-2 13a3 3 0 0 1-3 2h-6a3 3 0 0 1-3-2l-2-13zm3 0v-4a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v4" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
      <circle cx="19" cy="36" r="2" fill="white"/>
      <circle cx="29" cy="36" r="2" fill="white"/>
    </svg>
    <span id="cartFabCount" class="cart-fab-count">0</span>
    <div class="cart-preview" id="cartPreview" role="status" aria-live="polite"></div>
  </button>

  <div id="cartModal" class="modal-bg" aria-hidden="true"></div>
  <div id="deliveryModal" class="modal-bg" aria-hidden="true"></div>
  <div id="historyModal" class="modal-bg" aria-hidden="true"></div>
  <div id="imageModal" class="image-modal" onclick="closeImageModal()" role="dialog" aria-hidden="true">
    <img id="imageModalImg" src="" alt="">
  </div>

  <script>
    // -------------------------
    // Configuration (from original)
    // -------------------------
    const SHEET_API_URL = 'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';
    const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';
    const TELEGRAM_BOT_TOKEN = '8543195311:AAGzpZwTaUAgw3qp6AeKQA_BbFX35jtbJIk';
    const TELEGRAM_CHAT_ID = '7567253745';

    // -------------------------
    // App state
    // -------------------------
    let menuData = [];
    let cart = JSON.parse(localStorage.getItem('cart') || '{}');
    let favorites = (JSON.parse(localStorage.getItem('favorites') || '[]') || []).map(n => Number(n)).filter(n => !isNaN(n));
    let orderHistory = JSON.parse(localStorage.getItem('orderHistory') || '[]');
    let savedUserData = JSON.parse(localStorage.getItem('userData') || '{}');
    let orderCounter = parseInt(localStorage.getItem('orderCounter') || '0', 10) || 0;
    let currentFilter = 'all';

    const FMT = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 });

    function toNum(v) {
      if (typeof v === 'number') return v;
      if (!v) return 0;
      let s = String(v).replace(/[^\d,.\-]/g, '').replace(/,/g, '.');
      return parseFloat(s) || 0;
    }

    function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    function save(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){ console.warn('Storage error', e); } }

    function parseAvailable(value) {
      if (value === undefined || value === null) return true;
      const str = String(value).trim().toLowerCase();
      const falseValues = ['false', '–Ω–µ—Ç', 'no', '0', '–Ω', 'f', '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ', 'unavailable'];
      if (falseValues.includes(str)) return false;
      const trueValues = ['true', '–¥–∞', 'yes', '1', '–¥', 't', '–¥–æ—Å—Ç—É–ø–Ω–æ', 'available'];
      if (trueValues.includes(str)) return true;
      if (str === '') return true;
      if (!isNaN(Number(str))) return Number(str) !== 0;
      return true;
    }

    function debugLog(message, data) {
      // set to true to enable debug panel
      const showDebug = false;
      if (showDebug) console.log('[DEBUG]', message, data);
      const dp = document.getElementById('debugPanel');
      if (dp && showDebug) {
        dp.style.display = 'block';
        dp.textContent = JSON.stringify({message, data}, null, 2);
      }
    }

    // -------------------------
    // Loading menu
    // -------------------------
    async function loadMenu() {
      document.getElementById('loader').style.display = 'flex';
      try {
        debugLog('–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ API', SHEET_API_URL);
        const res = await fetch(SHEET_API_URL);
        if (!res.ok) throw new Error('Primary failed: ' + res.status);
        const json = await res.json();

        if (json?.values?.length > 0) {
          const rows = json.values;
          const headers = rows[0].map(h => String(h||'').trim().toLowerCase());
          const dataRows = rows.slice(1);

          const availableIndex = headers.findIndex(h =>
            h === 'available' || h === '–¥–æ—Å—Ç—É–ø–Ω–æ' || h === 'availability' || h === '–≤ –Ω–∞–ª–∏—á–∏–∏'
          );

          menuData = dataRows.map((row, idx) => {
            const obj = {};
            headers.forEach((h, i) => obj[h] = row[i] !== undefined ? row[i] : '');
            const availableValue = obj.available || obj['–¥–æ—Å—Ç—É–ø–Ω–æ'] || obj.availability || obj['–≤ –Ω–∞–ª–∏—á–∏–∏'] || (availableIndex >= 0 ? row[availableIndex] : undefined);
            return {
              id: idx + 1,
              name: obj.name || obj.title || `–ë–ª—é–¥–æ ${idx+1}`,
              description: obj.description || obj.desc || '',
              img: obj.img || obj.image || '',
              price: toNum(obj.price || obj.cost || obj['—Ü–µ–Ω–∞']),
              available: parseAvailable(availableValue)
            };
          });
          debugLog('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–ª—é–¥ (sheets)', menuData.length);
        } else if (json?.menu) {
          menuData = json.menu.map((item, idx) => ({
            id: idx + 1,
            name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
            description: item.description || '',
            img: item.img || '',
            price: toNum(item.price),
            available: parseAvailable(item.available)
          }));
          debugLog('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–ª—é–¥ (menu)', menuData.length);
        } else {
          throw new Error('Unexpected sheet response');
        }
      } catch (e) {
        console.warn('Primary sheet failed, trying fallback', e);
        // try fallback script (expected to return JSON array)
        try {
          const res2 = await fetch(SHEET_API_FALLBACK);
          if (!res2.ok) throw new Error('Fallback failed: ' + res2.status);
          const json2 = await res2.json();
          if (Array.isArray(json2)) {
            menuData = json2.map((item, idx) => ({
              id: idx + 1,
              name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
              description: item.description || '',
              img: item.img || '',
              price: toNum(item.price),
              available: parseAvailable(item.available)
            }));
            debugLog('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–ª—é–¥ (fallback array)', menuData.length);
          } else if (json2?.menu) {
            menuData = json2.menu.map((item, idx) => ({
              id: idx + 1,
              name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
              description: item.description || '',
              img: item.img || '',
              price: toNum(item.price),
              available: parseAvailable(item.available)
            }));
            debugLog('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –±–ª—é–¥ (fallback menu)', menuData.length);
          } else {
            throw new Error('Unexpected fallback response');
          }
        } catch (e2) {
          console.error('Failed to load menu', e2);
          // As last resort provide sample items so UI still works
          menuData = [
            { id:1, name:'–ü–∏—Ü—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º –∏ —Å—ã—Ä–æ–º', img:'https://picsum.photos/seed/pizza/800/600', price:250000, available:true },
            { id:2, name:'–°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä—å', description:'–° –∫—É—Ä–∏—Ü–µ–π –∏ —Å–æ—É—Å–æ–º —Ü–µ–∑–∞—Ä—å', img:'https://picsum.photos/seed/caesar/800/600', price:150000, available:true },
            { id:3, name:'–°—É–ø –¥–Ω—è', description:'–ì–æ—Ä—è—á–∏–π –∏ —Å–≤–µ–∂–∏–π', img:'https://picsum.photos/seed/soup/800/600', price:90000, available:false }
          ];
        }
      } finally {
        document.getElementById('loader').style.display = 'none';
        renderMenu();
        updateFavCount();
        updateHistoryCount();
        updateCartFab();
      }
    }

    // -------------------------
    // Rendering
    // -------------------------
    function renderMenu() {
      const container = document.getElementById('menu');
      container.innerHTML = '';
      const list = menuData.filter(item => {
        if (currentFilter === 'favorites') return favorites.includes(item.id);
        return true;
      });

      if (!list.length) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-light);">–ù–µ—Ç –±–ª—é–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        return;
      }

      list.forEach(item => {
        const inCart = cart[item.id] ? cart[item.id] : 0;
        const isFav = favorites.includes(item.id);

        const prod = document.createElement('div');
        prod.className = 'product' + (item.available ? '' : ' unavailable');

        prod.innerHTML = `
          <div class="product-img-wrap">
            ${!item.available ? '<div class="prod-unavailable">–ù–ï–î–û–°–¢–£–ü–ù–û</div>' : ''}
            <img class="product-img" src="${esc(item.img) || 'https://picsum.photos/seed/' + (item.id) + '/800/600'}" alt="${esc(item.name)}" loading="lazy" />
            <button class="favorite-btn ${isFav ? 'active' : ''}" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚≠ê</button>
          </div>
          <div class="product-content">
            <div class="product-name">${esc(item.name)}</div>
            <div class="product-desc">${esc(item.description)}</div>
            <div class="product-footer">
              <div class="product-price">${FMT.format(item.price)}</div>
              <div class="controls" data-id="${item.id}">
                <button class="remove-btn" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                <span class="count">${inCart}</span>
                <button class="add-btn" aria-label="–î–æ–±–∞–≤–∏—Ç—å" title="–î–æ–±–∞–≤–∏—Ç—å">+</button>
              </div>
            </div>
          </div>
        `;

        // hook up events after insertion
        container.appendChild(prod);

        // favorite button
        const favBtn = prod.querySelector('.favorite-btn');
        favBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          toggleFavorite(item.id, favBtn);
        });

        // image click to open modal
        const img = prod.querySelector('.product-img');
        img.addEventListener('click', () => openImageModal(item.img, item.name));

        // controls
        const addBtn = prod.querySelector('.add-btn');
        const removeBtn = prod.querySelector('.remove-btn');
        const countEl = prod.querySelector('.count');

        addBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!item.available) return;
          addToCart(item.id, 1);
          countEl.textContent = cart[item.id] || 0;
        });

        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (!item.available) return;
          removeFromCart(item.id, 1);
          countEl.textContent = cart[item.id] || 0;
        });
      });
    }

    // -------------------------
    // Favorites
    // -------------------------
    function toggleFavorite(id, btn) {
      id = Number(id);
      if (favorites.includes(id)) {
        favorites = favorites.filter(x => x !== id);
        btn.classList.remove('active');
      } else {
        favorites.push(id);
        btn.classList.add('active');
      }
      save('favorites', favorites);
      updateFavCount();
      if (currentFilter === 'favorites') renderMenu();
    }

    function updateFavCount() {
      document.getElementById('favCount').textContent = favorites.length;
    }

    // -------------------------
    // Cart functions
    // -------------------------
    function addToCart(id, qty = 1) {
      id = Number(id);
      const item = menuData.find(m => m.id === id);
      if (!item || !item.available) return;
      cart[id] = (cart[id] || 0) + qty;
      if (cart[id] <= 0) delete cart[id];
      save('cart', cart);
      updateCartFab();
    }

    function removeFromCart(id, qty = 1) {
      id = Number(id);
      if (!cart[id]) return;
      cart[id] = cart[id] - qty;
      if (cart[id] <= 0) delete cart[id];
      save('cart', cart);
      updateCartFab();
    }

    function clearCart() {
      cart = {};
      save('cart', cart);
      updateCartFab();
    }

    function cartItems() {
      return Object.keys(cart).map(k => {
        const id = Number(k);
        const m = menuData.find(x => x.id === id) || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', price: 0 };
        return { id, qty: cart[k], name: m.name, price: m.price || 0 };
      });
    }

    function cartTotal() {
      return cartItems().reduce((s, it) => s + (it.price || 0) * it.qty, 0);
    }

    // Update FAB visibility and count + preview content
    function updateCartFab() {
      const fab = document.getElementById('cartFab');
      const countEl = document.getElementById('cartFabCount');
      const preview = document.getElementById('cartPreview');
      const items = cartItems();
      const totalQty = items.reduce((s,i) => s + i.qty, 0);
      if (totalQty > 0) {
        fab.style.display = 'flex';
        countEl.textContent = totalQty;
        preview.innerHTML = `<div class="cart-preview-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
          ${items.map(it => `<div class="cart-preview-item"><span>${esc(it.name)} x ${it.qty}</span><strong>${FMT.format((it.price||0) * it.qty)}</strong></div>`).join('')}
          <div class="cart-preview-total">–ò—Ç–æ–≥–æ: ${FMT.format(cartTotal())}</div>`;
      } else {
        fab.style.display = 'none';
        countEl.textContent = '0';
        preview.innerHTML = '';
      }

      // Update counts in rendered product cards
      document.querySelectorAll('.controls').forEach(c => {
        const id = Number(c.getAttribute('data-id'));
        const span = c.querySelector('.count');
        if (span) span.textContent = cart[id] || 0;
      });
    }

    // Show cart modal
    function openCartModal() {
      const modalRoot = document.getElementById('cartModal');
      modalRoot.innerHTML = '';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `<button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <div class="modal-title">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</div>
        <div id="cartContent"></div>`;
      modalRoot.appendChild(modal);
      modalRoot.classList.add('show');
      modalRoot.setAttribute('aria-hidden', 'false');

      modal.querySelector('.modal-close').addEventListener('click', closeCartModal);

      const content = modal.querySelector('#cartContent');
      const items = cartItems();
      if (!items.length) {
        content.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-light)">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
        return;
      }

      const ul = document.createElement('ul');
      ul.className = 'cart-list';
      items.forEach(it => {
        const li = document.createElement('li');
        li.innerHTML = `<div style="flex:1">${esc(it.name)} <div style="font-size:13px;color:var(--text-light)">${it.qty} x ${FMT.format(it.price)}</div></div>
          <div style="text-align:right"><strong>${FMT.format(it.price * it.qty)}</strong><div style="margin-top:8px"><button class="btn-repeat" data-id="${it.id}">‚Äî</button> <button class="btn-repeat" data-id-add="${it.id}">+</button></div></div>`;
        ul.appendChild(li);
      });
      content.appendChild(ul);

      const total = document.createElement('div');
      total.className = 'cart-total';
      total.textContent = `–ò—Ç–æ–≥–æ: ${FMT.format(cartTotal())}`;
      content.appendChild(total);

      const checkoutBtn = document.createElement('button');
      checkoutBtn.className = 'btn-primary';
      checkoutBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
      checkoutBtn.addEventListener('click', () => {
        openDeliveryModal();
        closeCartModal();
      });
      content.appendChild(checkoutBtn);

      // bind +/- in modal
      content.querySelectorAll('[data-id]').forEach(b => {
        b.addEventListener('click', () => {
          removeFromCart(Number(b.getAttribute('data-id')), 1);
          renderMenu();
          content.querySelectorAll('.cart-total').forEach(t => t.textContent = `–ò—Ç–æ–≥–æ: ${FMT.format(cartTotal())}`);
          openCartModal(); // refresh
        });
      });
      content.querySelectorAll('[data-id-add]').forEach(b => {
        b.addEventListener('click', () => {
          addToCart(Number(b.getAttribute('data-id-add')), 1);
          renderMenu();
          openCartModal(); // refresh
        });
      });
    }

    function closeCartModal() {
      const modalRoot = document.getElementById('cartModal');
      modalRoot.classList.remove('show');
      modalRoot.setAttribute('aria-hidden', 'true');
      modalRoot.innerHTML = '';
    }

    // -------------------------
    // Delivery/Checkout
    // -------------------------
    function openDeliveryModal() {
      const modalRoot = document.getElementById('deliveryModal');
      modalRoot.innerHTML = '';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `<button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <div class="modal-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
        <div id="deliveryContent"></div>`;
      modalRoot.appendChild(modal);
      modalRoot.classList.add('show');
      modalRoot.setAttribute('aria-hidden', 'false');

      modal.querySelector('.modal-close').addEventListener('click', closeDeliveryModal);

      const content = modal.querySelector('#deliveryContent');

      const formHtml = `
        <div class="form-group">
          <label>–ò–º—è</label>
          <input id="userName" value="${esc(savedUserData.name || '')}" placeholder="–í–∞—à–µ –∏–º—è">
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="userPhone" value="${esc(savedUserData.phone || '')}" placeholder="+998..." inputmode="tel">
        </div>
        <div class="form-group">
          <label>–ê–¥—Ä–µ—Å</label>
          <input id="userAddress" value="${esc(savedUserData.address || '')}" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥">
        </div>
        <div class="form-group">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="userComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É"></textarea>
        </div>
        <div style="margin-bottom:16px;color:var(--text-light)">–ò—Ç–æ–≥–æ: <strong>${FMT.format(cartTotal())}</strong></div>
        <button id="sendOrderBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      `;
      content.innerHTML = formHtml;

      document.getElementById('sendOrderBtn').addEventListener('click', async () => {
        const name = document.getElementById('userName').value.trim();
        const phone = document.getElementById('userPhone').value.trim();
        const address = document.getElementById('userAddress').value.trim();
        const comment = document.getElementById('userComment').value.trim();
        if (!phone) {
          alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
          return;
        }

        // save user data
        savedUserData = { name, phone, address };
        save('userData', savedUserData);

        // create order text
        const items = cartItems();
        if (!items.length) {
          alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
          return;
        }
        orderCounter = (orderCounter || 0) + 1;
        save('orderCounter', orderCounter);

        const orderText = `–ó–∞–∫–∞–∑ #${orderCounter}\n–ö–ª–∏–µ–Ω—Ç: ${name || '-'}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address || '-'}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment || '-'}\n\n–°–æ—Å—Ç–∞–≤:\n` +
          items.map(it => `${it.name} x${it.qty} ‚Äî ${FMT.format((it.price||0) * it.qty)}`).join('\n') +
          `\n\n–ò—Ç–æ–≥–æ: ${FMT.format(cartTotal())}`;

        showLoader('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...');

        try {
          // Try to send to Telegram via bot (CORS may block)
          const telegramUrl = `https://api.telegram.org/bot${encodeURIComponent(TELEGRAM_BOT_TOKEN)}/sendMessage`;
          await fetch(telegramUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: orderText })
          });
        } catch (e) {
          console.warn('Telegram send failed', e);
          // ignore errors
        } finally {
          hideLoader();
          // add to history
          orderHistory.unshift({
            id: 'ord-' + Date.now(),
            counter: orderCounter,
            text: orderText,
            created_at: new Date().toISOString()
          });
          save('orderHistory', orderHistory);
          // clear cart
          clearCart();
          closeDeliveryModal();
          alert('–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
          renderMenu();
          updateHistoryCount();
        }
      });
    }

    function closeDeliveryModal() {
      const modalRoot = document.getElementById('deliveryModal');
      modalRoot.classList.remove('show');
      modalRoot.setAttribute('aria-hidden', 'true');
      modalRoot.innerHTML = '';
    }

    // -------------------------
    // Order history
    // -------------------------
    function showOrderHistory() {
      const modalRoot = document.getElementById('historyModal');
      modalRoot.innerHTML = '';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `<button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        <div class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
        <div id="historyContent"></div>`;
      modalRoot.appendChild(modal);
      modalRoot.classList.add('show');
      modalRoot.setAttribute('aria-hidden', 'false');

      modal.querySelector('.modal-close').addEventListener('click', () => {
        modalRoot.classList.remove('show');
        modalRoot.setAttribute('aria-hidden', 'true');
        modalRoot.innerHTML = '';
      });

      const content = modal.querySelector('#historyContent');
      if (!orderHistory.length) {
        content.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-light)">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
        return;
      }

      content.innerHTML = orderHistory.map(h => `
        <div class="history-item">
          <div class="history-header">
            <div>–ó–∞–∫–∞–∑ #${h.counter || '-'}</div>
            <div>${new Date(h.created_at).toLocaleString()}</div>
          </div>
          <div class="history-products"><pre style="white-space:pre-wrap;margin:0">${esc(h.text)}</pre></div>
        </div>
      `).join('');
    }

    function updateHistoryCount() {
      document.getElementById('historyCount').textContent = orderHistory.length;
    }

    // -------------------------
    // Image modal
    // -------------------------
    function openImageModal(src, alt) {
      const modal = document.getElementById('imageModal');
      const img = document.getElementById('imageModalImg');
      img.src = src || '';
      img.alt = alt || '';
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      const img = document.getElementById('imageModalImg');
      img.src = '';
    }

    // -------------------------
    // Loader utils
    // -------------------------
    function showLoader(text = '–û–±—Ä–∞–±–æ—Ç–∫–∞...') {
      const loader = document.getElementById('loader');
      loader.querySelector('.loader-text').textContent = text;
      loader.style.display = 'flex';
    }
    function hideLoader() {
      const loader = document.getElementById('loader');
      loader.style.display = 'none';
    }

    // -------------------------
    // UI helpers and filters
    // -------------------------
    function filterMenu(filter) {
      currentFilter = filter;
      document.querySelectorAll('.menu-controls button').forEach(b => b.classList.remove('active'));
      if (filter === 'all') document.getElementById('filterAll').classList.add('active');
      else if (filter === 'favorites') document.getElementById('filterFavorites').classList.add('active');
      renderMenu();
    }

    // Attach FAB click
    document.getElementById('cartFab').addEventListener('click', (e) => {
      // If click hits the preview area do nothing; open modal otherwise
      openCartModal();
    });

    // Close modals when clicking outside modal content
    document.querySelectorAll('.modal-bg').forEach(bg => {
      bg.addEventListener('click', (e) => {
        if (e.target === bg) {
          bg.classList.remove('show');
          bg.setAttribute('aria-hidden', 'true');
          bg.innerHTML = '';
        }
      });
    });

    // Accessibility: close image modal with ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeImageModal();
        closeCartModal();
        closeDeliveryModal();
        document.querySelectorAll('.modal-bg.show').forEach(bg => {
          bg.classList.remove('show');
          bg.setAttribute('aria-hidden', 'true');
          bg.innerHTML = '';
        });
      }
    });

    // -------------------------
    // Init
    // -------------------------
    (function init(){
      // Ensure numeric keys in cart are numbers
      const fixed = {};
      Object.keys(cart||{}).forEach(k => {
        const n = Number(k);
        if (!isNaN(n)) fixed[n] = cart[k];
      });
      cart = fixed;
      save('cart', cart);
      loadMenu();
    })();
  </script>
</body>
</html>
