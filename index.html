<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SvoyaKyhnya</title>
  <style>
    /* Minimal styles so the page is usable */
    body { font-family: Inter, system-ui, Arial, sans-serif; margin:0; padding:16px; background:#f7f7f7; color:#222; }
    #menu { display:flex; flex-wrap:wrap; gap:12px; }
    .product { width:220px; background:#fff; border-radius:8px; padding:10px; position:relative; box-shadow:0 6px 14px rgba(0,0,0,.06);}
    .product.unavailable { opacity:.5; }
    .product-img { width:100%; height:120px; object-fit:cover; border-radius:6px; cursor:pointer; }
    .product-name { font-weight:600; margin-top:8px; }
    .product-desc { font-size:13px; color:#666; margin:6px 0; min-height:36px; }
    .product-price { color:#2a6b2a; font-weight:700; margin-bottom:8px; }
    .controls { display:flex; align-items:center; gap:8px; justify-content:center; }
    .add-btn, .remove-btn, .order-btn, .delivery-btn { cursor:pointer; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; }
    .order-btn { background:#2a6b2a; color:#fff; border:0; }
    #menuLoader.visible { display:block; margin-bottom:12px; }
    #menuLoader { display:none; margin-bottom:12px; color:#555; }
    /* cartFab */
    #cartFab { display:flex; align-items:center; justify-content:center; gap:8px; position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:#2a6b2a; color:#fff; z-index:150; box-shadow:0 6px 16px rgba(0,0,0,.2); border:0; }
    #cartModalBg { display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:200; }
    .cart-modal { background:#fff; border-radius:8px; padding:16px; min-width:280px; max-width:90%; max-height:90%; overflow:auto; }
    .cart-title { font-weight:700; margin-bottom:8px; }
    .cart-list { list-style:none; padding:0; margin:8px 0; display:flex; flex-direction:column; gap:6px; }
    .cart-close { position:absolute; right:14px; top:10px; border:0; background:none; font-size:20px; cursor:pointer; }
    hr { border:none; border-top:1px solid #eee; margin:8px 0; }
  </style>
</head>
<body>
  <div id="menuLoader">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é‚Ä¶</div>
  <div id="menu"></div>

  <button id="cartFab" title="–ö–æ—Ä–∑–∏–Ω–∞" style="display:none;">
    üõí <span id="cartFabCount"></span>
  </button>

  <div id="cartModalBg" aria-hidden="true"></div>

  <script>
/* =====================================================
   USER IDENTIFICATION (local user)
   - generate per-browser user id and store in localStorage
===================================================== */
const USER_ID = localStorage.getItem('USER_ID') ||
  ('user_' + Math.random().toString(36).slice(2));
localStorage.setItem('USER_ID', USER_ID);

/* =====================================================
   STORAGE HELPERS
===================================================== */
function load(key, def) {
  try { return JSON.parse(localStorage.getItem(key)) ?? def; }
  catch { return def; }
}
function save(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

/* =====================================================
   GLOBAL STATE
===================================================== */
let menuData = [];
let cart = load('cart_' + USER_ID, {});
let favorites = load('fav_' + USER_ID, []);
let orderHistory = load('orders_' + USER_ID, []);
let userProfile = load('profile_' + USER_ID, {
  name: '',
  phone: '',
  addresses: []
});

/* =====================================================
   FORMATTERS
===================================================== */
const VND = new Intl.NumberFormat('vi-VN', {
  style: 'currency', currency: 'VND', maximumFractionDigits: 0
});

function toNumberSafe(v) {
  if (v === null || v === undefined || v === '') return 0;
  // remove non digits
  const n = Number(String(v).replace(/[^\d]/g,'')) || 0;
  return n;
}

function esc(s){
  return String(s||'').replace(/[&<>"']/g,
    m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* =====================================================
   SAVE STATE
===================================================== */
function persistAll() {
  save('cart_' + USER_ID, cart);
  save('fav_' + USER_ID, favorites);
  save('orders_' + USER_ID, orderHistory);
  save('profile_' + USER_ID, userProfile);
}

/* =====================================================
   API SETTINGS (placeholders: replace SPREADSHEET_ID/API_KEY)
===================================================== */
const SHEET_API_URL =
  'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';

const SHEET_API_FALLBACK =
  'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

/* =====================================================
   LOADER
===================================================== */
function showLoader() {
  document.getElementById('menuLoader')?.classList.add('visible');
  const el = document.getElementById('menuLoader');
  if (el) el.style.display = 'block';
}
function hideLoader() {
  document.getElementById('menuLoader')?.classList.remove('visible');
  const el = document.getElementById('menuLoader');
  if (el) el.style.display = 'none';
}

/* =====================================================
   LOAD MENU
===================================================== */
async function loadMenu() {
  showLoader();
  try {
    const r = await fetch(SHEET_API_URL);
    if (!r.ok) throw new Error('Sheet fetch failed');
    const j = await r.json();
    // Google Sheets API v4 returns { range, majorDimension, values: [...] }
    if (j.values) parseMenu(j.values);
    else throw new Error('No values in sheet response');
  } catch (err) {
    // fallback: try script endpoint that might return { menu: [...] }
    try {
      const r2 = await fetch(SHEET_API_FALLBACK);
      const j2 = await r2.json();
      const list = j2.menu || j2 || [];
      menuData = Array.isArray(list) ? list.map((i,idx)=>({
        id: idx+1,
        name: i.name || i.title || ('Item ' + (idx+1)),
        description: i.description || '',
        img: i.img || i.image || '',
        price: toNumberSafe(i.price || i.cost || 0),
        available: String(i.available ?? 'true').toLowerCase() !== 'false'
      })) : [];
    } catch (err2) {
      console.warn('Menu load failed:', err, err2);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é');
    }
  } finally {
    hideLoader();
    renderMenu();
    updateCartFab();
  }
}

/* =====================================================
   PARSE GOOGLE SHEET
   rows: array of arrays (first row = header)
===================================================== */
function parseMenu(rows) {
  if (!Array.isArray(rows) || !rows.length) { menuData = []; return; }
  const head = rows[0].map(h=>String(h||'').toLowerCase());
  menuData = rows.slice(1).map((r,idx)=>{
    const o={}; head.forEach((h,i)=>o[h]=r[i]);
    return {
      id: idx+1,
      name: o.name || o.title || '',
      description: o.description || '',
      img: o.img || o.image || '',
      price: toNumberSafe(o.price || 0),
      available: String(o.available ?? 'true').toLowerCase() !== 'false'
    };
  });
}

/* =====================================================
   RENDER MENU
===================================================== */
function renderMenu() {
  const m = document.getElementById('menu');
  if (!m) return;
  m.innerHTML = '';

  menuData.forEach(item=>{
    const q = cart[item.id]?.qty || 0;
    const fav = favorites.includes(item.id);

    const d = document.createElement('div');
    d.className = 'product' + (!item.available ? ' unavailable' : '');
    d.innerHTML = `
      <button onclick="toggleFavorite(${item.id})"
        style="position:absolute;right:8px;top:8px;font-size:22px;background:none;border:none">
        ${fav ? '‚ù§Ô∏è' : 'ü§ç'}
      </button>
      <img src="${esc(item.img)}" class="product-img"
           onclick="zoomImage('${esc(item.img)}')">
      <div class="product-name">${esc(item.name)}</div>
      <div class="product-desc">${esc(item.description)}</div>
      <div class="product-price">${VND.format(item.price)}</div>
      <div class="controls">
        <button class="remove-btn" onclick="updateCart(${item.id},-1)">‚àí</button>
        <span id="qty-${item.id}">${q}</span>
        <button class="add-btn" onclick="updateCart(${item.id},1)">+</button>
      </div>
    `;
    m.appendChild(d);
  });

  updateCartFab();
}

/* =====================================================
   CART
===================================================== */
function updateCart(id, d) {
  const item = menuData.find(i=>i.id===id);
  if (!item) return;

  if (!cart[id]) cart[id] = { ...item, qty: 0 };
  cart[id].qty = (cart[id].qty || 0) + d;
  if (cart[id].qty <= 0) delete cart[id];

  persistAll();
  renderMenu();
  animateCart();
}

function updateCartFab() {
  const f = document.getElementById('cartFab');
  const n = document.getElementById('cartFabCount');
  if (!f || !n) return;

  const c = Object.values(cart).reduce((s,i)=>s + (i.qty || 0), 0);
  if (c > 0) { f.style.display = 'flex'; n.textContent = c; }
  else { f.style.display = 'none'; n.textContent = ''; }
}

/* =====================================================
   CART ANIMATION
===================================================== */
function animateCart(){
  const f = document.getElementById('cartFab');
  if (!f) return;
  f.style.transform = 'scale(1.2)';
  setTimeout(()=>{ if (f) f.style.transform = ''; }, 200);
}

/* =====================================================
   CART MODAL
===================================================== */
function showCartModal(){
  const bg = document.getElementById('cartModalBg');
  if (!bg) return;
  const items = Object.values(cart);
  const total = items.reduce((s,i)=>s + (i.price || 0) * (i.qty || 0), 0);

  bg.innerHTML = `
    <div class="cart-modal" role="dialog" aria-modal="true">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
      <ul class="cart-list">
        ${items.map(i=>`
          <li>
            ${esc(i.name)} x${i.qty}
            <b style="float:right">${VND.format((i.price||0)*(i.qty||0))}</b>
          </li>`).join('')}
      </ul>
      <div class="cart-total" style="margin-top:8px">–ò—Ç–æ–≥–æ: ${VND.format(total)}</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="order-btn" onclick="openOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
        <button class="remove-btn" onclick="closeCartModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>`;
  bg.style.display = 'flex';
  bg.setAttribute('aria-hidden','false');
}

function closeCartModal(){
  const bg = document.getElementById('cartModalBg');
  if (!bg) return;
  bg.style.display = 'none';
  bg.setAttribute('aria-hidden','true');
}

/* =====================================================
   IMAGE ZOOM
===================================================== */
function zoomImage(src){
  if (!src) return;
  const z = document.createElement('div');
  z.style = 'position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:999';
  z.innerHTML = `<img src="${esc(src)}" style="max-width:90%;max-height:90%;border-radius:8px">`;
  z.onclick = ()=>z.remove();
  document.body.appendChild(z);
}

/* =====================================================
   FAVORITES
===================================================== */
function toggleFavorite(id){
  favorites = favorites.includes(id)
    ? favorites.filter(f=>f!==id)
    : [...favorites,id];
  persistAll();
  renderMenu();
}

/* =====================================================
   ORDER HISTORY
===================================================== */
function saveOrder(order) {
  orderHistory.unshift(order);
  orderHistory = orderHistory.slice(0, 20);
  persistAll();
}

/* =====================================================
   OPEN ORDER FORM
===================================================== */
function openOrder() {
  const bg = document.getElementById('cartModalBg');
  if (!bg) return;
  const items = Object.values(cart);
  if (!items.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');

  bg.innerHTML = `
    <div class="cart-modal" role="dialog" aria-modal="true">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>

      <input id="o-name" placeholder="–ò–º—è" value="${esc(userProfile.name)}" style="width:100%;padding:8px;margin:6px 0">
      <input id="o-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${esc(userProfile.phone)}" style="width:100%;padding:8px;margin:6px 0">
      <select id="o-address" style="width:100%;padding:8px;margin:6px 0">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å</option>
        ${userProfile.addresses.map(a=>`<option>${esc(a)}</option>`).join('')}
      </select>
      <input id="o-address-new" placeholder="–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å" style="width:100%;padding:8px;margin:6px 0">

      <textarea id="o-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="width:100%;padding:8px;margin:6px 0"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="order-btn" onclick="confirmOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="remove-btn" onclick="closeCartModal()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>`;
  bg.style.display = 'flex';
}

/* =====================================================
   CONFIRM ORDER
===================================================== */
function confirmOrder() {
  const nameEl = document.getElementById('o-name');
  const phoneEl = document.getElementById('o-phone');
  const addrNewEl = document.getElementById('o-address-new');
  const addrSelEl = document.getElementById('o-address');

  if (!nameEl || !phoneEl || !addrNewEl || !addrSelEl) return alert('–§–æ—Ä–º–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞');

  const name = nameEl.value.trim();
  const phone = phoneEl.value.trim();
  const addrNew = addrNewEl.value.trim();
  const addrSel = addrSelEl.value;

  if (!name || !phone || !(addrNew || addrSel))
    return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');

  if (addrNew) userProfile.addresses.push(addrNew);

  userProfile.name = name;
  userProfile.phone = phone;

  const items = Object.values(cart);
  const total = items.reduce((s,i)=>s + (i.price || 0) * (i.qty || 0), 0);

  saveOrder({
    date: new Date().toLocaleString(),
    items: JSON.parse(JSON.stringify(items)),
    total
  });

  cart = {};
  persistAll();
  closeCartModal();
  renderMenu();

  alert('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
}

/* =====================================================
   ORDER HISTORY VIEW
===================================================== */
function showOrderHistory() {
  const bg = document.getElementById('cartModalBg');
  if (!bg) return;

  if (!orderHistory || !orderHistory.length) {
    return alert('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞');
  }

  bg.innerHTML = `
    <div class="cart-modal" role="dialog" aria-modal="true">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
      <ul class="cart-list">
        ${orderHistory.map((o,idx)=>`
          <li style="display:flex;flex-direction:column;align-items:flex-start;gap:6px">
            <div style="width:100%;display:flex;justify-content:space-between">
              <b>${esc(o.date)}</b>
              <div>${VND.format(o.total)}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="remove-btn" onclick="repeatOrder(${idx})">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            </div>
          </li>`).join('')}
      </ul>
    </div>`;
  bg.style.display='flex';
}

/* =====================================================
   REPEAT ORDER
===================================================== */
function repeatOrder(idx) {
  if (!orderHistory[idx]) return alert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
  cart = {};
  (orderHistory[idx].items || []).forEach(i=>{
    cart[i.id] = { ...i };
  });
  persistAll();
  closeCartModal();
  renderMenu();
  alert('–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

/* =====================================================
   FAVORITES QUICK ORDER
===================================================== */
function orderFavorites() {
  if (!favorites.length) return alert('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ');
  favorites.forEach(id=>{
    const item = menuData.find(i=>i.id===id);
    if (!item) return;
    if (!cart[id]) cart[id] = { ...item, qty: 0 };
    cart[id].qty = (cart[id].qty || 0) + 1;
  });
  persistAll();
  renderMenu();
  alert('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

/* =====================================================
   GEOLOCATION ADDRESS
===================================================== */
function detectLocation() {
  if (!navigator.geolocation)
    return alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    const addr =
      `–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
    userProfile.addresses.push(addr);
    persistAll();
    alert('–ê–¥—Ä–µ—Å –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }, () => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å'));
}

/* =====================================================
   AUTO SAVE ORDER FORM
===================================================== */
document.addEventListener('input', e => {
  if (!e.target) return;
  if (e.target.id === 'o-name') {
    userProfile.name = e.target.value;
    persistAll();
  }
  if (e.target.id === 'o-phone') {
    userProfile.phone = e.target.value;
    persistAll();
  }
});

/* =====================================================
   INIT DOM-DEPENDENT ELEMENTS
   - run after DOM is ready to avoid null element errors
===================================================== */
window.addEventListener('DOMContentLoaded', () => {
  // create and append actionBar
  const actionBar = document.createElement('div');
  actionBar.style = `
    position:fixed;top:10px;right:10px;
    display:flex;gap:8px;z-index:300;
  `;
  actionBar.innerHTML = `
    <button class="delivery-btn" onclick="showOrderHistory()">üßæ –ò—Å—Ç–æ—Ä–∏—è</button>
    <button class="delivery-btn" onclick="orderFavorites()">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="delivery-btn" onclick="detectLocation()">üìç –ì–µ–æ</button>
  `;
  document.body.appendChild(actionBar);

  // create miniCart
  const miniCart = document.createElement('div');
  miniCart.style = `
    position:fixed;bottom:90px;right:18px;
    background:#fff;border:2px solid #556B2F;
    border-radius:12px;padding:10px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
    display:none;z-index:200;min-width:200px;
    font-family:inherit;font-size:14px;
  `;
  document.body.appendChild(miniCart);

  const cartFab = document.getElementById('cartFab');
  if (cartFab) {
    cartFab.onclick = showCartModal;

    cartFab.addEventListener('mouseenter', () => {
      const items = Object.values(cart);
      if (!items.length) return;
      miniCart.innerHTML = items.map(i =>
        `<div>${esc(i.name)} √ó${i.qty}</div>`
      ).join('') +
      `<hr><b>${VND.format(items.reduce((s,i)=>s+(i.price||0)*(i.qty||0),0))}</b>`;
      miniCart.style.display = 'block';
    });
    cartFab.addEventListener('mouseleave', () => {
      miniCart.style.display = 'none';
    });
  }

  // make sure we have a cartModalBg to close on click outside
  const bg = document.getElementById('cartModalBg');
  if (bg) {
    bg.addEventListener('click', (e) => {
      if (e.target === bg) closeCartModal();
    });
  }

  // initial UI state and start loading menu
  renderMenu();
  updateCartFab();
  loadMenu();
});

/* =====================================================
   SAFETY: CLOSE MODALS ON ESC
===================================================== */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeCartModal();
    document.querySelectorAll('.delivery-modal.show')
      .forEach(m=>m.classList.remove('show'));
  }
});
  </script>
</body>
</html>
