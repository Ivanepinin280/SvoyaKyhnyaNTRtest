<script>
/* =====================================================
   USER IDENTIFICATION (local user)
===================================================== */
const USER_ID = localStorage.getItem('USER_ID') ||
  'user_' + Math.random().toString(36).slice(2);
localStorage.setItem('USER_ID', USER_ID);

/* =====================================================
   STORAGE HELPERS
===================================================== */
function load(key, def) {
  try { return JSON.parse(localStorage.getItem(key)) ?? def; }
  catch { return def; }
}
function save(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

/* =====================================================
   GLOBAL STATE
===================================================== */
let menuData = [];
let cart = load('cart_' + USER_ID, {});
let favorites = load('fav_' + USER_ID, []);
let orderHistory = load('orders_' + USER_ID, []);
let userProfile = load('profile_' + USER_ID, {
  name: '',
  phone: '',
  addresses: []
});

/* =====================================================
   FORMATTERS
===================================================== */
const VND = new Intl.NumberFormat('vi-VN', {
  style: 'currency', currency: 'VND', maximumFractionDigits: 0
});

function toNumberSafe(v) {
  if (!v) return 0;
  return Number(String(v).replace(/[^\d]/g,'')) || 0;
}

function esc(s){
  return String(s||'').replace(/[&<>"']/g,
    m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* =====================================================
   SAVE STATE
===================================================== */
function persistAll() {
  save('cart_' + USER_ID, cart);
  save('fav_' + USER_ID, favorites);
  save('orders_' + USER_ID, orderHistory);
  save('profile_' + USER_ID, userProfile);
}
/* =====================================================
   API SETTINGS
===================================================== */
const SHEET_API_URL =
  'https://sheets.googleapis.com/v4/spreadsheets/SPREADSHEET_ID/values/Sheet1?key=API_KEY';

const SHEET_API_FALLBACK =
  'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

/* =====================================================
   LOADER
===================================================== */
function showLoader() {
  document.getElementById('menuLoader')?.classList.add('visible');
}
function hideLoader() {
  document.getElementById('menuLoader')?.classList.remove('visible');
}

/* =====================================================
   LOAD MENU
===================================================== */
async function loadMenu() {
  showLoader();
  try {
    const r = await fetch(SHEET_API_URL);
    if (!r.ok) throw 0;
    const j = await r.json();
    parseMenu(j.values);
  } catch {
    try {
      const r2 = await fetch(SHEET_API_FALLBACK);
      const j2 = await r2.json();
      menuData = j2.menu.map((i,idx)=>({
        id: idx+1,
        name: i.name,
        description: i.description,
        img: i.img,
        price: toNumberSafe(i.price),
        available: String(i.available).toLowerCase()!=='false'
      }));
    } catch {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é');
    }
  }
  hideLoader();
  renderMenu();
}

/* =====================================================
   PARSE GOOGLE SHEET
===================================================== */
function parseMenu(rows) {
  const head = rows[0].map(h=>h.toLowerCase());
  menuData = rows.slice(1).map((r,idx)=>{
    const o={}; head.forEach((h,i)=>o[h]=r[i]);
    return {
      id: idx+1,
      name: o.name,
      description: o.description,
      img: o.img,
      price: toNumberSafe(o.price),
      available: String(o.available).toLowerCase()!=='false'
    };
  });
}

/* =====================================================
   RENDER MENU
===================================================== */
function renderMenu() {
  const m = document.getElementById('menu');
  m.innerHTML = '';

  menuData.forEach(item=>{
    const q = cart[item.id]?.qty || 0;
    const fav = favorites.includes(item.id);

    const d = document.createElement('div');
    d.className = 'product' + (!item.available?' unavailable':'');
    d.innerHTML = `
      <button onclick="toggleFavorite(${item.id})"
        style="position:absolute;right:8px;top:8px;font-size:22px;background:none;border:none">
        ${fav?'‚ù§Ô∏è':'ü§ç'}
      </button>
      <img src="${item.img}" class="product-img"
           onclick="zoomImage('${item.img}')">
      <div class="product-name">${esc(item.name)}</div>
      <div class="product-desc">${esc(item.description)}</div>
      <div class="product-price">${VND.format(item.price)}</div>
      <div class="controls">
        <button class="remove-btn" onclick="updateCart(${item.id},-1)">‚àí</button>
        <span id="qty-${item.id}">${q}</span>
        <button class="add-btn" onclick="updateCart(${item.id},1)">+</button>
      </div>
    `;
    m.appendChild(d);
  });

  updateCartFab();
}

/* =====================================================
   CART
===================================================== */
function updateCart(id, d) {
  const item = menuData.find(i=>i.id===id);
  if (!item) return;

  if (!cart[id]) cart[id]={...item,qty:0};
  cart[id].qty+=d;
  if (cart[id].qty<=0) delete cart[id];

  persistAll();
  renderMenu();
  animateCart();
}

function updateCartFab() {
  const c = Object.values(cart).reduce((s,i)=>s+i.qty,0);
  const f = document.getElementById('cartFab');
  const n = document.getElementById('cartFabCount');
  if (c>0){ f.style.display='flex'; n.textContent=c; }
  else f.style.display='none';
}

/* =====================================================
   CART ANIMATION
===================================================== */
function animateCart(){
  const f=document.getElementById('cartFab');
  f.style.transform='scale(1.2)';
  setTimeout(()=>f.style.transform='',200);
}

/* =====================================================
   CART MODAL
===================================================== */
document.getElementById('cartFab').onclick=showCartModal;

function showCartModal(){
  const bg=document.getElementById('cartModalBg');
  const items=Object.values(cart);
  const total=items.reduce((s,i)=>s+i.price*i.qty,0);

  bg.innerHTML=`
    <div class="cart-modal">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
      <ul class="cart-list">
        ${items.map(i=>`
          <li>
            ${esc(i.name)} x${i.qty}
            <b>${VND.format(i.price*i.qty)}</b>
          </li>`).join('')}
      </ul>
      <div class="cart-total">–ò—Ç–æ–≥–æ: ${VND.format(total)}</div>
      <button class="order-btn" onclick="openOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
    </div>`;
  bg.style.display='flex';
}

function closeCartModal(){
  document.getElementById('cartModalBg').style.display='none';
}

/* =====================================================
   IMAGE ZOOM
===================================================== */
function zoomImage(src){
  const z=document.createElement('div');
  z.style=`position:fixed;inset:0;background:rgba(0,0,0,.7);
           display:flex;align-items:center;justify-content:center;z-index:999`;
  z.innerHTML=`<img src="${src}" style="max-width:90%;max-height:90%">`;
  z.onclick=()=>z.remove();
  document.body.appendChild(z);
}

/* =====================================================
   FAVORITES
===================================================== */
function toggleFavorite(id){
  favorites = favorites.includes(id)
    ? favorites.filter(f=>f!==id)
    : [...favorites,id];
  persistAll();
  renderMenu();
}

/* =====================================================
   INIT
===================================================== */
loadMenu();
/* =====================================================
   ORDER HISTORY
===================================================== */
function saveOrder(order) {
  orderHistory.unshift(order);
  orderHistory = orderHistory.slice(0, 20);
  persistAll();
}

/* =====================================================
   OPEN ORDER FORM
===================================================== */
function openOrder() {
  const bg = document.getElementById('cartModalBg');
  const items = Object.values(cart);
  if (!items.length) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');

  bg.innerHTML = `
    <div class="cart-modal">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>

      <input id="o-name" placeholder="–ò–º—è" value="${esc(userProfile.name)}">
      <input id="o-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" value="${esc(userProfile.phone)}">
      <select id="o-address">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å</option>
        ${userProfile.addresses.map(a=>`<option>${esc(a)}</option>`).join('')}
      </select>
      <input id="o-address-new" placeholder="–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å">

      <textarea id="o-comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

      <button class="order-btn" onclick="confirmOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>`;
}

/* =====================================================
   CONFIRM ORDER
===================================================== */
function confirmOrder() {
  const name = document.getElementById('o-name').value.trim();
  const phone = document.getElementById('o-phone').value.trim();
  const addrNew = document.getElementById('o-address-new').value.trim();
  const addrSel = document.getElementById('o-address').value;

  if (!name || !phone || !(addrNew || addrSel))
    return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');

  if (addrNew) userProfile.addresses.push(addrNew);

  userProfile.name = name;
  userProfile.phone = phone;

  const items = Object.values(cart);
  const total = items.reduce((s,i)=>s+i.price*i.qty,0);

  saveOrder({
    date: new Date().toLocaleString(),
    items: JSON.parse(JSON.stringify(items)),
    total
  });

  cart = {};
  persistAll();
  closeCartModal();
  renderMenu();

  alert('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
}

/* =====================================================
   ORDER HISTORY VIEW
===================================================== */
function showOrderHistory() {
  const bg = document.getElementById('cartModalBg');
  bg.innerHTML = `
    <div class="cart-modal">
      <button class="cart-close" onclick="closeCartModal()">√ó</button>
      <div class="cart-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
      <ul class="cart-list">
        ${orderHistory.map((o,idx)=>`
          <li style="flex-direction:column;align-items:flex-start">
            <b>${o.date}</b>
            <div>${VND.format(o.total)}</div>
            <button class="remove-btn" onclick="repeatOrder(${idx})">
              –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
            </button>
          </li>`).join('')}
      </ul>
    </div>`;
  bg.style.display='flex';
}

/* =====================================================
   REPEAT ORDER
===================================================== */
function repeatOrder(idx) {
  cart = {};
  orderHistory[idx].items.forEach(i=>{
    cart[i.id] = {...i};
  });
  persistAll();
  closeCartModal();
  renderMenu();
  alert('–ó–∞–∫–∞–∑ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
}

/* =====================================================
   FAVORITES QUICK ORDER
===================================================== */
function orderFavorites() {
  if (!favorites.length) return alert('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ');
  favorites.forEach(id=>{
    const item = menuData.find(i=>i.id===id);
    if (!item) return;
    if (!cart[id]) cart[id]={...item,qty:0};
    cart[id].qty++;
  });
  persistAll();
  renderMenu();
  alert('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
}
/* =====================================================
   MINI CART PREVIEW (hover)
===================================================== */
const miniCart = document.createElement('div');
miniCart.style = `
  position:fixed;bottom:90px;right:18px;
  background:#fff;border:2px solid #556B2F;
  border-radius:12px;padding:10px;
  box-shadow:0 6px 18px rgba(0,0,0,.15);
  display:none;z-index:200;min-width:200px;
  font-family:inherit;font-size:14px;
`;
document.body.appendChild(miniCart);

document.getElementById('cartFab').onmouseenter = () => {
  const items = Object.values(cart);
  if (!items.length) return;
  miniCart.innerHTML = items.map(i =>
    `<div>${esc(i.name)} √ó${i.qty}</div>`
  ).join('') +
  `<hr><b>${VND.format(items.reduce((s,i)=>s+i.price*i.qty,0))}</b>`;
  miniCart.style.display = 'block';
};
document.getElementById('cartFab').onmouseleave = () => {
  miniCart.style.display = 'none';
};

/* =====================================================
   GEOLOCATION ADDRESS
===================================================== */
function detectLocation() {
  if (!navigator.geolocation)
    return alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    const addr =
      `–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
    userProfile.addresses.push(addr);
    persistAll();
    alert('–ê–¥—Ä–µ—Å –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }, () => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å'));
}

/* =====================================================
   AUTO SAVE ORDER FORM
===================================================== */
document.addEventListener('input', e => {
  if (e.target.id === 'o-name') userProfile.name = e.target.value;
  if (e.target.id === 'o-phone') userProfile.phone = e.target.value;
  persistAll();
});

/* =====================================================
   TOP ACTION BUTTONS
===================================================== */
const actionBar = document.createElement('div');
actionBar.style = `
  position:fixed;top:10px;right:10px;
  display:flex;gap:8px;z-index:300;
`;
actionBar.innerHTML = `
  <button class="delivery-btn" onclick="showOrderHistory()">üßæ –ò—Å—Ç–æ—Ä–∏—è</button>
  <button class="delivery-btn" onclick="orderFavorites()">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
  <button class="delivery-btn" onclick="detectLocation()">üìç –ì–µ–æ</button>
`;
document.body.appendChild(actionBar);

/* =====================================================
   RESTORE UI STATE
===================================================== */
window.addEventListener('load', () => {
  renderMenu();
  updateCartFab();
});

/* =====================================================
   SAFETY: CLOSE MODALS ON ESC
===================================================== */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeCartModal();
    document.querySelectorAll('.delivery-modal.show')
      .forEach(m=>m.classList.remove('show'));
  }
});
