<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–í–û–Ø –ö–£–•–ù–Ø ‚Äî –∑–∞–∫–∞–∑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{background:#f7efe0;font-family:Arial,sans-serif;}
    .center{max-width:500px;margin:32px auto;background:#fffbe6;padding:22px 18px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,.09);}
    .main-label{font-size:1.4em;margin-bottom:20px;}
    label{display:block;margin:10px 0 2px;}
    input,select,textarea{width:100%;margin-bottom:12px;padding:7px;border-radius:6px;border:1px solid #d1a94a;}
    button{background:#b3611f;border:none;border-radius:7px;color:#fff;padding:12px 20px;margin-top:10px;font-size:1.1em;cursor:pointer;}
    .info{margin:7px 0 20px;color:#7c5600;font-size:0.96em;}
    .success{color:#2e7d32;margin:16px 0;font-size:1.09em;}
    .error{color:#b23c17;margin:9px 0;}
    .cart {margin-top:28px;}
    .cart-title {font-weight:bold;margin-bottom:7px;}
    .cart-list{margin-bottom:12px;}
    .cart-list-item{margin:2px 0;}
    .cart-total{margin-bottom:12px;}
    .add-btn,.remove-btn{background:#556B2F;color:#fff;border:none;border-radius:4px;font-size:1em;padding:3px 8px;cursor:pointer;margin:0 3px;}
    .remove-btn{background:#fff;color:#556B2F;border:1px solid #6b7a29;}
    .cart-summary{margin-bottom:8px;}
  </style>
</head>
<body>
  <div class="center">
    <div class="main-label">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</div>
    <div class="info">
      <b>–®–∞–≥ 1.</b> –ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –Ω–∞—à–µ–º—É –±–æ—Ç—É –≤ Telegram: <a href="https://t.me/–í–ê–®_BOT_USERNAME" target="_blank">@–í–ê–®_BOT_USERNAME</a>.<br>
      <b>–®–∞–≥ 2.</b> –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username (–±–µ–∑ @).<br>
      –ü–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç –∑–∞–∫–∞–∑ —Å –∫–Ω–æ–ø–∫–∞–º–∏ "–ü—Ä–∏–Ω—è—Ç—å" –∏ "–û—Ç–∫–ª–æ–Ω–∏—Ç—å", –∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram.
    </div>
    <div class="cart" id="cartRoot"></div>
    <form id="orderForm">
      <label for="tgUsername">–í–∞—à Telegram username (–±–µ–∑ @):</label>
      <input id="tgUsername" required placeholder="–ü—Ä–∏–º–µ—Ä: vasya_pupkin">
      <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
      <input id="phone" required placeholder="8-XXX-XXX-XX-XX">
      <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
      <input id="address" required placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
      <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É:</label>
      <textarea id="comment" rows="2" placeholder="(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button type="submit" id="orderBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      <div class="success" id="resultSuccess" style="display:none;"></div>
      <div class="error" id="resultError" style="display:none;"></div>
    </form>
  </div>
<script>
// === –ù–ê–°–¢–†–û–ô–ö–ò ===
const TELEGRAM_OPERATOR_CHAT_ID = '7567253745'; // –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à chat_id –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞!
const TELEGRAM_BOT_TOKEN = '7637734194:AAGLXLycqKlHpi4183_4Jaaaz3bwm_SJXqw'; // –ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –¢–û–ö–ï–ù –±–æ—Ç–∞!
// –î–ª—è –º–µ–Ω—é
const SHEET_API_FALLBACK = 'https://script.google.com/macros/s/AKfycbyytR-HwA0y-TnHS_7nygs-_ZkPHDYzQQWFgV3GJSVuvdn93oX0kP92Ti9bQVqW7C_gFg/exec';

let menuData = [];
let cart = {};

const RUB_FMT = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 });

function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

async function loadMenu() {
  try {
    const res = await fetch(SHEET_API_FALLBACK);
    const j2 = await res.json();
    if (j2 && j2.menu && Array.isArray(j2.menu)) {
      menuData = j2.menu.map((item, idx) => ({
        id: idx + 1,
        name: item.name || `–ë–ª—é–¥–æ ${idx+1}`,
        description: item.description || '',
        img: item.img || '',
        price: Number(item.price) || 0,
        available: String(item.available).trim().toLowerCase() === 'true'
      }));
      renderMenu();
      return;
    }
    document.getElementById('cartRoot').innerHTML += '<div>–ú–µ–Ω—é –ø—É—Å—Ç–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</div>';
  } catch (e) {
    document.getElementById('cartRoot').innerHTML += '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é.</div>';
  }
}
function renderMenu() {
  const cartRoot = document.getElementById('cartRoot');
  cartRoot.innerHTML = '<div class="cart-title">–ú–µ–Ω—é:</div>';
  if (!menuData || menuData.length === 0) {
    cartRoot.innerHTML += '<div style="color:#556B2F;font-size:1.05em;text-align:center;">–ù–µ—Ç –º–µ–Ω—é</div>';
    return;
  }
  let html = '<div class="cart-list">';
  menuData.forEach(item => {
    html += `<div class="cart-list-item">
      <b>${escapeHtml(item.name)}</b>: ${escapeHtml(item.description)}
      <br>–¶–µ–Ω–∞: ${RUB_FMT.format(item.price)}
      <br>
      <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">‚àí</button>
      <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
      <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
    </div>`;
  });
  html += '</div>';
  cartRoot.innerHTML += html;
  renderCartSummary();
}
function renderCartSummary() {
  const cartRoot = document.getElementById('cartRoot');
  const itemsArr = Object.values(cart);
  const total = itemsArr.reduce((s,i)=>s + (i.price || 0) * i.qty, 0);
  let summary = '';
  const descr = itemsArr.length
    ? itemsArr.map(i=>`${escapeHtml(i.name)} x${i.qty} ‚Äî ${RUB_FMT.format(i.price*i.qty)}`).join('<br>')
    : '<i>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</i>';
  summary += `<div class="cart-summary">${descr}</div>`;
  summary += `<div class="cart-total"><b>–ò—Ç–æ–≥–æ: ${RUB_FMT.format(total)}</b></div>`;
  let sumEl = document.getElementById('cart-summary-block');
  if (!sumEl){
    sumEl = document.createElement('div');
    sumEl.id = 'cart-summary-block';
    cartRoot.appendChild(sumEl);
  }
  sumEl.innerHTML = summary;
}
window.updateCart = function(id, delta) {
  const item = menuData.find(i=>i.id===id);
  if (!item || !item.available) return;
  if (!cart[id]) cart[id] = { ...item, qty: 0 };
  cart[id].qty = Math.max(0, cart[id].qty + delta);
  if (cart[id].qty === 0) delete cart[id];
  const qtyEl = document.getElementById(`qty-${id}`);
  if (qtyEl) qtyEl.textContent = cart[id]?.qty || 0;
  renderCartSummary();
};

// ===== –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê –æ–ø–µ—Ä–∞—Ç–æ—Ä—É —Å –ö–ù–û–ü–ö–ê–ú–ò =====
document.getElementById('orderForm').onsubmit = async function(e){
  e.preventDefault();
  const btn = document.getElementById('orderBtn');
  const okDiv = document.getElementById('resultSuccess');
  const errDiv = document.getElementById('resultError');
  okDiv.style.display='none'; errDiv.style.display='none';
  btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  const username = document.getElementById('tgUsername').value.trim().replace(/^@/,'');
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const comment = document.getElementById('comment').value.trim();

  if (!username || !phone || !address) {
    errDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!'; errDiv.style.display = 'block';
    btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return;
  }
  const itemsArr = Object.values(cart);
  if (itemsArr.length === 0) { errDiv.textContent='–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'; errDiv.style.display='block'; btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'; return; }
  const total = itemsArr.reduce((s,i)=>s + (i.price||0)*i.qty,0);
  let orderLines = itemsArr.map(i=>`${i.name} x${i.qty} ‚Äî ${RUB_FMT.format(i.price * i.qty)}`).join('\n');
  const orderId = 'ord_' + Math.random().toString(36).substr(2,7); // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –∑–∞–∫–∞–∑–∞
  const orderTxt =
    `üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑\n` +
    `Telegram username: @${username}\n` +
    `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n` +
    `–ê–¥—Ä–µ—Å: ${address}\n` +
    (comment ? `–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${comment}\n` : '') +
    `–ó–∞–∫–∞–∑:\n${orderLines}\n` +
    `–°—É–º–º–∞: ${RUB_FMT.format(total)}\n` +
    `ID –∑–∞–∫–∞–∑–∞: ${orderId}`;

  // reply_markup –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞!
  const msg = {
    chat_id: TELEGRAM_OPERATOR_CHAT_ID,
    text: orderTxt,
    reply_markup: JSON.stringify({
      inline_keyboard: [
        [
          {text:"‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data:`accept_${username}_${orderId}`},
          {text:"‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data:`decline_${username}_${orderId}`}
        ]
      ]
    })
  };
  try {
    const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(msg)
    });
    const result = await res.json();
    if(result.ok){
      okDiv.textContent = '–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏–µ –≤ Telegram.'; okDiv.style.display='block';
      btn.style.display='none';
      cart = {};
      renderMenu();
    } else {
      errDiv.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."; errDiv.style.display='block';
      btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
    }
  } catch(e) {
    errDiv.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞."; errDiv.style.display='block';
    btn.disabled = false; btn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
  }
};

loadMenu();
</script>
</body>
</html>
